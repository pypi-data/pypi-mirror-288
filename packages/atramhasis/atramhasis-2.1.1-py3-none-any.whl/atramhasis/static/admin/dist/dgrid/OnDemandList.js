//>>built
define("dgrid/OnDemandList","./List ./_StoreMixin dojo/_base/declare dojo/_base/lang dojo/dom-construct dojo/on dojo/when dojo/query ./util/misc".split(" "),function(W,X,Y,Z,t,aa,ba,da,P){function Q(a){return a&&(0<=a.className.indexOf("dgrid-row")||0<=a.className.indexOf("dgrid-loading"))}function H(a){return a&&0<=a.className.indexOf("dgrid-preload")}var R=0;return Y([W,X],{minRowsPerPage:25,maxRowsPerPage:250,maxEmptySpace:Infinity,bufferRows:10,farOffRemoval:2E3,queryRowsOverlap:0,pagingMethod:"debounce",
pagingDelay:P.defaultDelay,keepScrollPosition:!1,rowHeight:0,_deleteQueue:[],postCreate:function(){this.inherited(arguments);var a=this;aa(this.bodyNode,"scroll",P[this.pagingMethod](function(b){a._processScroll(b)},null,this.pagingDelay))},renderQuery:function(a,b){var d=this,f=b&&b.container||this.contentNode,c,m=0,e=b&&b.start||0;"level"in a&&(m=c=a.level);var u={query:a,count:0,level:m,top:!1};var q={node:t.create("div",{className:"dgrid-preload",style:{height:"0"}},f),count:0,query:a,next:u,
level:m,top:!0};var A=q.node;A.rowIndex=0;u.previous=q;var x=u.node=t.create("div",{className:"dgrid-preload",style:{height:"0"}},f);q.id=R++;A.setAttribute("data-preloadid",q.id);u.id=R++;x.setAttribute("data-preloadid",u.id);x.rowIndex=this.minRowsPerPage;d._insertPreload(q);var D=t.create("div",{className:"dgrid-loading"},x,"before");t.create("div",{className:"dgrid-below"},D).innerHTML=this.loadingMessage;b=Z.mixin({start:0,count:this.minRowsPerPage},b);null!=c&&(b.queryLevel=c);return this._trackError(function(){var E=
a(b);return d.renderQueryResults(E,x,b).then(function(F){return E.totalLength.then(function(h){var k=F.length,n=x.parentNode;!d._rows||"queryLevel"in b||(d._rows.min=0,d._rows.max=k===h?Infinity:k-1);t.destroy(D);"queryLevel"in b||(d._total=h);0===h&&n&&(d.noDataNode&&t.destroy(d.noDataNode),d._insertNoDataNode(n));q.count=e;u.count=h-k-e;x.rowIndex=e+k;h?d._updatePreloadRowHeights(q):(x.style.display="none",A.style.display="none");d._previousScrollPosition&&n.offsetHeight&&(d.scrollTo(d._previousScrollPosition),
delete d._previousScrollPosition);return ba(d._processScroll()).then(function(){return F})})}).otherwise(function(F){t.destroy(D);throw F;})})},_insertPreload:function(a){var b=this.preload;if(b){for(;b.node.compareDocumentPosition(a.node)&Node.DOCUMENT_POSITION_PRECEDING;)if(b=b.previous,null==b)return;for(;b.node.compareDocumentPosition(a.node)&Node.DOCUMENT_POSITION_FOLLOWING&&b.next;)b=b.next;b.previous.next=a;a.previous=b.previous;a=a.next;a.next=b;b.previous=a}else this.preload=a},refresh:function(a){var b=
this,d=a&&a.keepScrollPosition;"undefined"===typeof d&&(d=this.keepScrollPosition);d&&(this._previousScrollPosition=this.getScrollPosition());this.inherited(arguments);if(this._renderedCollection)return this.renderQuery(function(f){return b._renderedCollection.fetchRange({start:f.start,end:f.start+f.count})}).then(function(){b._emitRefreshComplete()})},resize:function(){this.inherited(arguments);this._processScroll()},cleanup:function(){this.inherited(arguments);this.preload=null},renderQueryResults:function(a){var b=
this.inherited(arguments),d=this._getRenderedCollection(this.preload);d&&d.releaseRange&&b.then(function(f){f[0]&&!f[0].parentNode.tagName&&a.totalLength.then(function(){d.releaseRange(f[0].rowIndex,f[f.length-1].rowIndex+1)})});return b},_getFirstRowSibling:function(a){return a.lastChild},_calcRowHeight:function(a){var b=a.nextSibling;return b&&!/\bdgrid-preload\b/.test(b.className)?b.offsetTop-a.offsetTop:a.offsetHeight},_calcAverageRowHeight:function(a){for(var b=a.length,d=0,f=0;f<b;f++)d+=this._calcRowHeight(a[f]);
return b&&d?d/b:0},_updatePreloadRowHeights:function(){var a=this.preload;if(a){for(;a.previous;)a=a.previous;for(;a;)a.rowHeight||(a.rowHeight=this.rowHeight||this._calcAverageRowHeight(a.node.parentNode.querySelectorAll(".dgrid-row")),this._adjustPreloadHeight(a)),a=a.next}},lastScrollTop:0,_processScroll:function(a){function b(g,p){for(var C=p?"next":"previous",y;y=g[C];)g=y;return g}function d(g,p){function C(){a:{var l=!p;for(var B=g;B=B[p?"previous":"next"];)if(l===B.top){l=B;break a}l=void 0}if(l&&
v!==l&&!H(l.top?l.node.nextSibling:l.node.previousSibling))return r(),g=l,I=g.node,G=p?g.node.offsetTop-A:q-(g.node.offsetTop+g.node.offsetHeight),S=(l=y(I))&&l.rowIndex,K=void 0,l}function y(l){var B=H(l);(l=l[ca])&&!Q(l)&&(l=B&&H(l)?null:(B=C())?B:y(l));return l}function r(){g.count+=L;p&&(I.rowIndex-=L);e._adjustPreloadHeight(g);L=0;e._releaseRange(g,p,S,K)}var v=g;g=b(g,p);var G=p?g.node.offsetTop-A:q-(g.node.offsetTop+g.node.offsetHeight),T=e.farOffRemoval,I=g.node,ca=p?"previousSibling":"nextSibling",
L=0,U=0,K;if(G>2*T){var w;var S=(w=y(I))&&w.rowIndex;for(K=void 0;w&&v!==g;){var V=e._calcRowHeight(w);U+V+T>G||!Q(w)?w=C():(U+=V,L+=w.count||1,e._pruneRow(w,p),"rowIndex"in w&&(K=w.rowIndex),w=y(w))}r();e._deleteNodeQueue()}}function f(g,p){do g=p?g.next:g.previous;while(g&&!g.node.offsetWidth);return g}var c=this.preload,m;this._updatePreloadRowHeights();if(m=c&&c.rowHeight){var e=this,u=e.bodyNode,q=a&&a.scrollTop||this.getScrollPosition().y,A=u.offsetHeight+q;a=e.lastScrollTop;u=e.bufferRows*
m;var x=u-m,D,E=!0;for(e.lastScrollTop=q;c&&!c.node.offsetWidth;)c=c.previous;for(;c&&c!==F;){var F=e.preload;e.preload=c;m=c.node;var h=m.offsetTop;if(A+1+x<h)c=f(c,E=!1);else if(q-1-x>h+m.offsetHeight)c=f(c,E=!0);else{h=((m.top?q-u:A)-h)/c.rowHeight;var k=(A-q+2*u)/c.rowHeight;k+=Math.min(Math.abs(Math.max(Math.min((q-a)*c.rowHeight,e.maxRowsPerPage/2),e.maxRowsPerPage/-2)),10);m.top&&(h-=k);h=Math.max(h,0);10>h&&0<h&&k+h<e.maxRowsPerPage&&(k+=Math.max(0,h),h=0);k=Math.min(Math.max(k,e.minRowsPerPage),
e.maxRowsPerPage,c.count);if(0===k)c=f(c,E);else{k=Math.ceil(k);h=Math.min(Math.floor(h),c.count-k);var n={};c.count-=k;var z=m,J=e.queryRowsOverlap,M=!c.top&&c;if(M)c.previous&&(d(c),0<h&&H(m.previousSibling)?(h=Math.min(c.count,h),c.previous.count+=h,e._adjustPreloadHeight(c.previous,!0),m.rowIndex+=h,J=0):k+=h,c.count-=h),n.start=m.rowIndex-J,n.count=Math.min(k+J,e.maxRowsPerPage),m.rowIndex=n.start+n.count;else{if(c.next)if(z=m.nextSibling,d(c,!0),H(m.nextSibling))c.next.count+=c.count-h,c.next.node.rowIndex=
h+k,e._adjustPreloadHeight(c.next),c.count=h,J=0,z=c.next.node;else var N=!0;n.start=c.count;n.count=Math.min(k+J,e.maxRowsPerPage);n.scrollingUp=!0}N&&z&&z.offsetWidth&&(N=z.offsetTop);e._adjustPreloadHeight(c);"level"in c.query&&(n.queryLevel=c.query.level);if("queryLevel"in n||!(n.start>e._total||0>n.count)){var O=t.create("div",{className:"dgrid-loading",style:{height:k*c.rowHeight+"px"}},z,"before");t.create("div",{className:"dgrid-"+(M?"below":"above"),innerHTML:e.loadingMessage},O);O.count=
k;e._trackError(function(){(function(g,p,C){var y=c.query(n);D=e.renderQueryResults(y,g,n).then(function(r){var v=e._rows;!v||"queryLevel"in n||!r.length||(p?(v.max<=v.min&&(v.min=r[0].rowIndex),v.max=r[r.length-1].rowIndex):(v.max<=v.min&&(v.max=r[r.length-1].rowIndex),v.min=r[0].rowIndex));z=g.nextSibling;t.destroy(g);C&&z&&z.offsetWidth&&e.scrollTo({y:e.bodyNode.scrollTop+z.offsetTop-C});y.totalLength.then(function(G){"queryLevel"in n||(e._total=G,e._rows&&e._rows.max>=e._total-1&&(e._rows.max=
Infinity));p&&(p.count=G-p.node.rowIndex,e._adjustPreloadHeight(p))});e._processScroll();return r},function(r){t.destroy(g);throw r;})})(O,M,N)});c=c.previous}}}}return D}},_adjustPreloadHeight:function(a,b){a.node.style.height=this._calculatePreloadHeight(a,b)+"px"},_calculatePreloadHeight:function(a,b){return Math.min(a.count*a.rowHeight,b?Infinity:this.maxEmptySpace)},_pruneRow:function(a,b,d){this.removeRow(a,!0,d);this._queueNodeForDeletion(a)},_queueNodeForDeletion:function(a){this._deleteQueue.push(a)},
_deleteNodeQueue:function(){for(var a=document.createElement("div"),b=this._deleteQueue,d=b.length;d--;)a.appendChild(b[d]);this._deleteQueue=[];setTimeout(function(){t.destroy(a)},1)},_removePreloads:function(a){if(a&&a.length){var b=this,d=this._getHeadPreload();a.forEach(function(f){if(f=b._findPreload(f,d))f.previous&&(f.previous.next=f.next),f.next&&(f.next.previous=f.previous)})}},_getHeadPreload:function(){var a=this.preload;if(a)for(;a.previous;)a=a.previous;return a},_findPreload:function(a,
b){b||(b=this._getHeadPreload());for(var d=b;d;){if(d.node===a)return d;d=d.next}},_getRenderedCollection:function(){return this._renderedCollection},_releaseRange:function(a,b,d,f){if(a){var c=a.level;a=this._getRenderedCollection(a);null!=f&&a.releaseRange&&"number"===typeof d&&"number"===typeof f&&(b?a.releaseRange(f,d+1):a.releaseRange(d,f+1),this._rows&&!c&&(this._rows[b?"max":"min"]=f,this._rows.max>=this._total-1&&(this._rows.max=Infinity)))}}})});
//# sourceMappingURL=OnDemandList.js.map