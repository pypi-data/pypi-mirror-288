//>>built
define("dgrid/Editor","dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/dom-construct dojo/dom-class dojo/on dojo/has dojo/query ./Grid dojo/_base/sniff".split(" "),function(v,q,p,r,t,n,u,w,x){return v(null,{constructor:function(){this._editorInstances={};this._editorColumnListeners=[];this._editorCellListeners={};this._editorsPendingStartup=[]},postCreate:function(){var a=this;this.inherited(arguments);this.on(".dgrid-input:focusin",function(){a._focusedEditorCell=a.cell(this)});this._editorFocusoutHandle=
n.pausable(this.domNode,".dgrid-input:focusout",function(){a._focusedEditorCell=null});this._listeners.push(this._editorFocusoutHandle)},insertRow:function(){this._editorRowListeners={};var a=this.inherited(arguments),b=this.row(a),c=this._editorCellListeners[a.id]=this._editorCellListeners[a.id]||{},d;for(d in this._editorRowListeners)c[d]=this._editorRowListeners[d];this._editorRowListeners=null;(c=this._previouslyFocusedEditorCell)&&c.row.id===b.id&&this.edit(this.cell(b,c.column.id));return a},
refresh:function(){for(var a in this._editorInstances){var b=this._editorInstances[a].domNode;b&&b.parentNode&&b.parentNode.removeChild(b)}return this.inherited(arguments)},removeRow:function(a){var b=this,c=this._focusedEditorCell;c&&c.row.id===this.row(a).id&&(this._previouslyFocusedEditorCell=c,this._editorFocusoutHandle.pause(),setTimeout(function(){b._editorFocusoutHandle.resume();b._previouslyFocusedEditorCell=null},0));if(this._editorCellListeners[a.id]){for(var d in this._editorCellListeners[a.id])this._editorCellListeners[a.id][d].remove();
delete this._editorCellListeners[a.id]}for(c=this._alwaysOnWidgetColumns.length;c--;)if(d=(d=this.cell(a,this._alwaysOnWidgetColumns[c].id).element)&&(d.contents||d).widget)this._editorFocusoutHandle.pause(),d.destroyRecursive();return this.inherited(arguments)},renderArray:function(){var a=this.inherited(arguments);a.length?this._startupPendingEditors():this._editorsPendingStartup=[];return a},_onNotification:function(){this.inherited(arguments);this._startupPendingEditors()},_destroyColumns:function(){this._editorStructureCleanup();
this.inherited(arguments)},_editorStructureCleanup:function(){var a=this._editorInstances,b=this._editorColumnListeners;this._editTimer&&clearTimeout(this._editTimer);for(var c in a){var d=a[c];d.domNode&&d.destroyRecursive()}this._editorInstances={};for(a=b.length;a--;)b[a].remove();for(var g in this._editorCellListeners)for(c in this._editorCellListeners[g])this._editorCellListeners[g][c].remove();for(a=0;a<this._editorColumnListeners.length;a++)this._editorColumnListeners[a].remove();this._editorCellListeners=
{};this._editorColumnListeners=[];this._editorsPendingStartup=[]},_configColumns:function(){var a=this.inherited(arguments);this._alwaysOnWidgetColumns=[];for(var b=0,c=a.length;b<c;b++)a[b].editor&&this._configureEditorColumn(a[b]);return a},_configureEditorColumn:function(a){var b=this,c=a.renderCell||this._defaultRenderCell,d=a.editOn,g="string"!==typeof a.editor;d?this._editorInstances[a.id]=this._createSharedEditor(a,c):g&&this._alwaysOnWidgetColumns.push(a);a.renderCell=d?function(e,l,h,f){if(!f||
!f.alreadyHooked){var m=n(h,d,function(){b._activeOptions=f;b.edit(this)});if(b._editorRowListeners)b._editorRowListeners[a.id]=m;else{var k=b.row(e);b._editorCellListeners[k.element.id][a.id]=m}}return c.call(a,e,l,h,f)}:function(e,l,h,f){if(!a.canEdit||a.canEdit(e,l))e=b._createEditor(a,e),b._showEditor(e,a,h,l),h[g?"widget":"input"]=e;else return c.call(a,e,l,h,f)}},edit:function(a){function b(y){c._activeCell=h;c._showEditor(g,e,h,m);c._editTimer=setTimeout(function(){g.focus&&g.focus();e._editorBlurHandle&&
e._editorBlurHandle.resume();c._editTimer=null;y.resolve(g)},0)}var c=this,d,g;a.column||(a=this.cell(a));if(!a||!a.element)return null;var e=a.column;var l=e.field;var h=a.element.contents||a.element;if(g=this._editorInstances[e.id]){if(this._activeCell!==h){var f=a.row;var m=(d=this.dirty&&this.dirty[f.id])&&l in d?d[l]:e.get?e.get(f.data):f.data[l];if(!e.canEdit||e.canEdit(a.row.data,m)){var k=new p;a=g.domNode||g;a.offsetWidth?(a.blur(),setTimeout(function(){b(k)},0)):b(k);return k.promise}}}else if(e.editor&&
(g=h.widget||h.input))return k=new p,g.focus&&g.focus(),k.resolve(g),k.promise;return null},refreshCell:function(a){var b=a.column,c=b.get?b.get(a.row.data):a.row.data[b.field],d;b.editor&&(a.column.editOn&&this._activeCell===a.element?d=this._editorInstances[a.column.id]:a.column.editOn||(d=a.element.widget||a.element.input));return d?(d.domNode?d.set("value",c):this._updateInputValue(d,c),(new p).resolve()):this.inherited(arguments)},_showEditor:function(a,b,c,d){var g=a.domNode;g||this._updateInputValue(a,
d);c.innerHTML="";t.add(c,"dgrid-cell-editing");g&&b.editOn&&a.validate&&a.reset&&a.reset();c.appendChild(a.domNode||a);g&&!b.editOn?this._editorsPendingStartup.push([a,b,c,d]):this._startupEditor(a,b,c,d)},_startupEditor:function(a,b,c,d){a.domNode&&(a._started||a.startup(),a._dgridIgnoreChange=!0,a.set("value",d),setTimeout(function(){a._dgridIgnoreChange=!1},0));a._dgridLastValue=d;this._activeCell&&(this._activeValue=d,n.emit(c,"dgrid-editor-show",{grid:this,cell:this.cell(c),column:b,editor:a,
bubbles:!0,cancelable:!1}))},_startupPendingEditors:function(){for(var a=this._editorsPendingStartup,b=a.length;b--;)this._startupEditor.apply(this,a[b]);this._editorsPendingStartup=[]},_handleEditorChange:function(a,b){var c=a.target;"_dgridLastValue"in c&&-1<c.className.indexOf("dgrid-input")&&this._updatePropertyFromEditor(b||this.cell(c).column,c,a)},_createEditor:function(a,b){var c=a.editor,d=a.editOn,g=this,e="string"!==typeof c&&c,l={};var h=a.editorArgs||{};"function"===typeof h&&(h=h.call(this,
a));if(e){var f=new e(h);h=f.focusNode||f.domNode;h.className+=" dgrid-input";f.on(d?"blur":"change",function(){f._dgridIgnoreChange||g._updatePropertyFromEditor(a,this,{type:"widget"})})}else this._hasInputListener||(this._hasInputListener=!0,this.on("change",function(k){g._handleEditorChange(k)})),"textarea"===c?e="textarea":(e="input",l.type=c),f=h=r.create(e,q.mixin(l,{className:"dgrid-input",name:a.field,tabIndex:isNaN(a.tabIndex)?-1:a.tabIndex},h)),9>u("ie")&&(c="radio"===c||"checkbox"===c?
n(f,"click",function(k){g._handleEditorChange(k,a)}):n(f,"change",function(k){g._handleEditorChange(k,a)}),d?this._editorColumnListeners.push(c):this._editorRowListeners?this._editorRowListeners[a.id]=c:this._editorCellListeners[this.row(b).element.id][a.id]=c);if(a.autoSelect){var m=f.focusNode||f;m.select&&n(m,"focus",function(){setTimeout(function(){m.select()},0)})}return f},_createSharedEditor:function(a){function b(){var f=d._activeCell;l.blur();"function"===typeof d.focus&&setTimeout(function(){d.focus(f)},
g&&9>u("ie")?15:0)}var c=this._createEditor(a),d=this,g=c.domNode,e=c.domNode||c,l=c.focusNode||e,h=g?function(){c.set("value",c._dgridLastValue)}:function(){d._updateInputValue(c,c._dgridLastValue);d._updatePropertyFromEditor(a,c)};this._editorColumnListeners.push(n(l,"keydown",function(f){f=f.keyCode||f.which;27===f?(h(),d._activeValue=c._dgridLastValue,b()):13===f&&!1!==a.dismissOnEnter&&b()}));(a._editorBlurHandle=n.pausable(c,"blur",function(){var f=e.parentNode,m={alreadyHooked:!0},k=d.cell(e);
n.emit(k.element,"dgrid-editor-hide",{grid:d,cell:k,column:a,editor:c,bubbles:!0,cancelable:!1});a._editorBlurHandle.pause();f.removeChild(e);k.row&&(t.remove(k.element,"dgrid-cell-editing"),r.empty(f),x.appendIfNode(f,a.renderCell(k.row.data,d._activeValue,f,d._activeOptions?q.delegate(m,d._activeOptions):m)));d._focusedEditorCell=d._activeCell=d._activeValue=d._activeOptions=null})).pause();this._editorColumnListeners.push(a._editorBlurHandle);return c},_updatePropertyFromEditor:function(a,b,c){var d;
if(!b.isValid||b.isValid())if(c=this._updateProperty((b.domNode||b).parentNode,this._activeCell?this._activeValue:b._dgridLastValue,this._retrieveEditorValue(a,b),c),this._activeCell?this._activeValue=c:b._dgridLastValue=c,"radio"===b.type&&b.name&&!a.editOn&&a.field)for(d in c=this.row(b),w("input[type\x3dradio][name\x3d"+b.name+"]",this.contentNode).forEach(function(g){var e=this.row(g);g!==b&&g._dgridLastValue&&(g._dgridLastValue=!1,this.updateDirty?this.updateDirty(e.id,a.field,!1):e.data[a.field]=
!1)},this),this.dirty)c.id.toString()!==d&&this.dirty[d][a.field]&&this.updateDirty(d,a.field,!1)},_updateProperty:function(a,b,c,d){var g=this;if((b&&b.valueOf())!==(c&&c.valueOf())){var e=this.cell(a),l=e.row,h=e.column;a=e.element;if(h.field&&l)if(e={grid:this,cell:e,oldValue:b,value:c,bubbles:!0,cancelable:!0},d&&d.type&&(e.parentType=d.type),n.emit(a,"dgrid-datachange",e))this.updateDirty?(this.updateDirty(l.id,h.field,c),h.autoSave&&setTimeout(function(){g._trackError("save")},0)):l.data[h.field]=
c;else{var f;(f=a.widget)?(f._dgridIgnoreChange=!0,f.set("value",b),setTimeout(function(){f._dgridIgnoreChange=!1},0)):(f=a.input)&&this._updateInputValue(f,b);return b}}return c},_updateInputValue:function(a,b){a.value=b;if("radio"===a.type||"checkbox"===a.type)a.checked=a.defaultChecked=!!b},_retrieveEditorValue:function(a,b){return"function"===typeof b.get?this._convertEditorValue(b.get("value")):this._convertEditorValue(b["checkbox"===b.type||"radio"===b.type?"checked":"value"])},_convertEditorValue:function(a,
b){if("number"===typeof b)a=isNaN(a)?a:parseFloat(a);else if("boolean"===typeof b)a="true"===a?!0:"false"===a?!1:a;else if(b instanceof Date){var c=new Date(a);a=isNaN(c.getTime())?a:c}return a}})});
//# sourceMappingURL=Editor.js.map