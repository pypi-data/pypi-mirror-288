//>>built
define("dstore/db/IndexedDB","dojo/_base/declare dojo/_base/lang dojo/Deferred dojo/when dojo/promise/all dstore/Store dstore/SimpleQuery dstore/QueryResults".split(" "),function(U,X,R,N,S,Y,Z,V){function W(a){var d=new R,b=!1,m=!1,c=!1,k=null;if(a.transaction){var n=a.transaction.oncomplete;b=!0;a.transaction.oncomplete=function(){m=!0;n&&n();c&&d.resolve(k)}}a.onsuccess=function(w){k=w.target.result;c=!0;b&&!m||d.resolve(k)};a.onerror=function(){a.error.message=a.webkitErrorMessage;d.reject(a.error)};
return d.promise}function O(a,d,b){if(F||P.length){a&&(P.push({cursor:a,priority:d,retry:b}),P.sort(function(c,k){return c.priority>k.priority?1:-1}));if(1<=F)return;var m=P.pop();a=m&&m.cursor}if(a)try{a["continue"](),F++}catch(c){if("TransactionInactiveError"!==c.name&&0!==c.name||!m)throw c;m.retry()}}function T(){return!0}var P=[],F=0,H=window.IDBKeyRange||window.webkitIDBKeyRange;return U([Y,Z],{constructor:function(a){U.safeMixin(this,a);var d=this,b=this.dbConfig;this.indices=b.stores[this.storeName];
this.cachedCount={};for(var m in d.indices)a=d.indices[m],"number"===typeof a&&(d.indices[m]={preference:a});this.db=this.db||b.db;if(!this.db){var c=b.openRequest;c||(c=b.openRequest=window.indexedDB.open(b.name||"dojo-db",parseInt(b.version,10)),c.onupgradeneeded=function(){var k=d.db=c.result,n;for(n in b.stores){var w=b.stores[n];if(k.objectStoreNames.contains(n))u=c.transaction.objectStore(n);else{u=w.idProperty||"id";var u=k.createObjectStore(n,{keyPath:u,autoIncrement:w[u]&&w[u].autoIncrement||
!1})}for(var p in w)u.indexNames.contains(p)||"autoIncrement"===p||"idProperty"===p||!1===w[p].indexed||u.createIndex(p,p,w[p])}},b.db=W(c));this.db=b.db.then(function(k){return d.db=k})}},idProperty:"id",storeName:"",indices:{},transaction:function(){var a=this;this._currentTransaction=null;return{abort:function(){a._currentTransaction.abort()},commit:function(){a._currentTransaction=null}}},_getTransaction:function(){if(!this._currentTransaction){this._currentTransaction=this.db.transaction([this.storeName],
"readwrite");var a=this;this._currentTransaction.oncomplete=function(){a._currentTransaction=null};this._currentTransaction.onerror=function(d){}}return this._currentTransaction},_callOnStore:function(a,d,b,m){var c=this;return N(this.db,function w(n){c.db.then&&(c.db=n);if(n=c._currentTransaction)var u=!0;else n=c._getTransaction();if(u)try{var p=n.objectStore(c.storeName);b&&(p=p.index(b));var q=p[a].apply(p,d)}catch(e){if("TransactionInactiveError"===e.name||"InvalidStateError"===e.name)return c._currentTransaction=
null,w();throw e;}else p=n.objectStore(c.storeName),b&&(p=p.index(b)),q=p[a].apply(p,d);return m?q:W(q)})},get:function(a){var d=this;return this._callOnStore("get",[a]).then(function(b){return d._restore(b)})},getIdentity:function(a){return a[this.idProperty]},put:function(a,d){d=d||{};this.cachedCount={};var b=this;return this._callOnStore(!1===d.overwrite?"add":"put",[a]).then(function(m){return b.get(m)})},add:function(a,d){d=d||{};d.overwrite=!1;return this.put(a,d)},remove:function(a){this.cachedCount=
{};return this._callOnStore("delete",[a])},fetch:function(){return this._fetch(T)},fetchRange:function(a){return this._fetch(T,a)},forEach:function(a,d){return this._fetch(function(b,m){a.call(d,b,m)})},_union:function(a,d,b){b=b||{};var m=b.start||0,c=b.end||Infinity,k=a.sort,n=a.select;b=a.filter;if(k){var w={sort:k};var u=this._createSortQuerier(w)}else u=function(x){return x};var p=[],q=0,e=0,t=0,v=[],f,l={},r=[],g=this;return new V(N(b).then(function(x){return S(x.map(function(C,I){function Q(h){J.push(h);
for(var B=[],D=[];v.every(function(G){if(0<G.length)return(G=G[0])&&D.push(G),B.push(G)});){if(t>=c||0===D.length){f=!0;return}h=u(D)[0];v[B.indexOf(h)].shift();if(t++>=m&&(r.push(h),!d(h))){f=!0;return}B=[];D=[]}return!0}var J=v[I]=[],L=g._query({filterFunction:a.filterFunction,filter:C,sort:k},function(h){if(!f){var B=g.getIdentity(h);e++;if(B in l)return!0;q++;l[B]=!0;return Q(h)}});p[I]=L.totalLength;return L.then(function(h){Q(null);return h})}))}).then(function(){return n?n.querier(r):r}),{totalLength:{then:function(){return S(p).then(function(x){return x.reduce(function(C,
I){return C+I})*q/(e||1)}).then.apply(this,arguments)}}})},_normalizeQuery:function(){function a(q){q.forEach(function v(t){if(m)throw Error("Can not process conditions after a union, rearrange the query with the union last");var f=t.type,l=[].slice.call(t.args,0),r=l[0],g=l[1];if(g&&g.fetch&&!g.data)u.push(g.fetch().then(function(x){g.data=x;v(t)},function(x){}));else if("or"===f)d(l);else if("and"===f)a(l);else if("eq"===f)b(r,g);else if("gt"===f||"gte"===f)l=c[r]||(c[r]={}),l.from=g,l.excludeFrom=
"gt"===f,b(r,l);else if("lt"===f||"lte"===f)l=c[r]||(c[r]={}),l.to=g,l.excludeTo="lt"===f,b(r,l);else if("in"===f)d((g.data||g).map(function(x){return{type:"eq",args:[r,x]}}));else if("contains"===f)l=c[r]||(c[r]={}),l.contains=g.data?g.data:g instanceof Array?g:[g],b(r,l);else if("match"===f){g=g.source;if("^"!==g[0]||g.match(/[\{\}\(\)\[\]\.,\$\*]/))throw Error("The match filter only supports simple prefix matching like /^starts with/");l=c[r]||(c[r]={});g=g.slice(1);l.from=g;l.to=g+"~";b(r,l)}else throw Error('Unsupported filter type "'+
f+'"');})}function d(q){m=q.map(function(e){c={};a([e]);return c})}function b(q,e){"boolean"!==typeof e&&(e&&(e.from||e.to?function(t,v){e.test=function(f){return!t||t<=f&&(!v||v>=f)};e.keyRange=t?v?H.bound(t,v,e.excludeFrom,e.excludeTo):H.lowerBound(t,e.excludeFrom):H.upperBound(v,e.excludeTo)}(e.from,e.to):"object"===typeof e&&e.contains&&function(t){var v=t[0];if("object"===typeof v&&"match"===v.type){if("^"===v.args[1].source[0]){var f=v.args[1].source.slice(1);f=H.bound(f,f+"~")}}else f=H.only(v);
e.test=function(l){return t.every(function(r){if("object"===typeof r&&"match"===r.type){var g=r.args[1];return l.some(function(x){return!!g.test(x)})}return l&&-1<l.indexOf(r)})};e.keyRange=f}(e.contains)),c[q]=e)}var m,c={},k,n,w,u=[];this.queryLog.forEach(function(q){var e=q.type,t=q.normalizedArguments;if("filter"===e){k=t;var v=p;p=v?function(f){return q.querier(v(f))}:q.querier;a(t,!0)}else"sort"===e?(n=t[0],n.querier=q.querier):"select"===e&&(w=q)});var p=p||function(q){return q};return{filter:0<
u.length?S(u).then(function(){return m}):m||c,filterFunction:p,filterOperator:k||null,sort:n,select:w}},_fetch:function(a,d){var b=this._normalizeQuery(),m=b.filter,c=this;return m instanceof Array||m.then?this._union(b,function(k){a(c._restore(k));return!0},d):this._query(b,function(k){a(c._restore(k));return!0},d)},_query:function(a,d,b){function m(y,A,E){q++;var z=k.indices[y];if(z&&!1!==z.indexed&&(A=A||z.preference*(E||1)||.001,A>p))return p=A,u=y,!0;q++}function c(){function y(A){F--;e.reject(A);
O()}N(k._callOnStore("openCursor",L,u,!0),function(A){F++;A.onsuccess=function(E){F--;var z=E.target.result;if(z){if(B){z.advance(B);F++;B=!1;return}h.preFilterOffset++;try{var K=z.value;b.join&&(K=b.join(K));return N(K,function(M){if(0<v([M]).length&&(h.offset++,h.offset>=n&&(D.push(M),!d(M,h.offset-n)||h.offset>=w-1))){A.lastCursor=z;e.resolve(D);O();return}return O(z,b.priority,function(){B=h.preFilterOffset+1;c()})})}catch(M){e.reject(M)}}else{if(!n||h.offset>=n)h.finished=!0;e.resolve(D)}O()};
A.onerror=y},y)}b=b||{};var k=this,n=b.start||0,w=b.end||Infinity,u,p=0,q=0,e=new R,t=e.promise,v=a.filterFunction;var f=a.filter;var l=a.sort,r=a.select,g;for(g in f){var x=f[g];m(g,null,x&&(x.from||x.to)?.1:1)}var C=JSON.stringify(a.filterOperator)+"-"+JSON.stringify(l);if(l)if(a=l[0],a.property===u||m(a.property,1))var I=a.descending;else{var Q=!0;n=0;w=Infinity}if(u){var J=u in f?(f=f[u])&&f.keyRange?f.keyRange:H.only(f):null;var L=[J,I?"prev":"next"]}else L=[];var h=k.cachedPosition;if(h&&h.queryId===
C&&h.offset<n&&1<q){var B=h.preFilterOffset+1;k.cachedPosition=h=X.mixin({},h)}else h=k.cachedPosition={offset:-1,preFilterOffset:-1,queryId:C},2>q&&(h.offset=h.preFilterOffset=(B=n)-1);var D=[];c();if(Q){var G=d;d=T;t=t.then(function(y){var A=b.start||0,E=b.end||Infinity;y=l.querier(y).slice(A,E);y.forEach(G);return y})}r&&(t=t.then(function(y){return r.querier(y)}));return new V(t,{totalLength:{then:function(y,A){function E(K){k.cachedCount[C]=K;return Math.round((h.offset+1.01)/(h.preFilterOffset+
1.01)*K)}var z=k.cachedCount[C];return z?y(E(z)):h.finished?(z=new R,z.resolve(h.offset+1),z.then(y)):(J?k._callOnStore("count",[J],u):k._callOnStore("count")).then(E).then(y,A)}}})}})});
//# sourceMappingURL=IndexedDB.js.map