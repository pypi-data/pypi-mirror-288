//>>built
define("dstore/db/SQL","dojo/_base/declare dojo/Deferred dojo/when dstore/QueryResults dstore/Store dstore/SimpleQuery dojo/_base/lang dojo/promise/all".split(" "),function(B,C,u,D,E,F,x,v){function y(a,b){for(var m=b.split("."),g=m.length,c=0;c<g;c++)a=a&&a[m[c]];return a}function t(a){return a.replace(/\./g,"_dot_")}function z(a){return a&&a.__extra?x.mixin(a,JSON.parse(a.__extra)):a}var A={and:" AND ",or:" OR ",eq:"\x3d",ne:"!\x3d",lte:"\x3c\x3d",gte:"\x3e\x3d",lt:"\x3c",gt:"\x3e"};return B([E,
F],{constructor:function(a){var b=a.dbConfig;this.database=openDatabase(a.dbName||"dojo-db","1.0","dojo-db",4194304);var m=this.indexPrefix=a.indexPrefix||"idx_",g=a.table||a.storeName;this.table=(a.table||a.storeName).replace(/[^\w]/g,"_");a=[];this.indices=b.stores[g];this.repeatingIndices={};for(var c in this.indices)this.indices[c].multiEntry&&(this.repeatingIndices[c]=!0);if(!b.available){for(g in b.stores){var f=b.stores[g],k=g.replace(/[^\w]/g,"_"),h=f[this.idProperty],d=["__extra",this.idProperty+
" "+(h&&h.autoIncrement?"INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY")];h=[this.idProperty];for(c in f)c!=this.idProperty&&d.push(t(c));a.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+k+" ("+d.join(",")+")"));for(c in f)c!=this.idProperty&&(f[c].multiEntry?(h.push(c),d=k+"_repeating_"+t(c),a.push(this.executeSql("CREATE TABLE IF NOT EXISTS "+d+" (id,value)")),a.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+d+"_id ON "+d+"(id)")),a.push(this.executeSql("CREATE INDEX IF NOT EXISTS idx_"+
d+"_value ON "+d+"(value)"))):(a.push(this.executeSql("ALTER TABLE "+k+" ADD "+t(c)).then(null,function(){})),!1!==f[c].indexed&&a.push(this.executeSql("CREATE INDEX IF NOT EXISTS "+m+k+"_"+t(c)+" ON "+k+"("+t(c)+")"))))}b.available=v(a)}this.available=b.available},idProperty:"id",selectColumns:["*"],get:function(a){var b=this;return u(this.executeSql("SELECT "+this.selectColumns.join(",")+" FROM "+this.table+" WHERE "+this.idProperty+"\x3d?",[a]),function(m){return 0<m.rows.length?b._restore(z(m.rows.item(0))):
void 0})},getIdentity:function(a){return a[this.idProperty]},remove:function(a){return this.executeSql("DELETE FROM "+this.table+" WHERE "+this.idProperty+"\x3d?",[a])},identifyGeneratedKey:!0,add:function(a){function b(e,p,l){h.repeatingIndices[l||e]?k.push(function(q){return v(p.map(function(w){return h.executeSql("INSERT INTO "+h.table+"_repeating_"+e+" (value, id) VALUES (?, ?)",[w,q])}))}):(c.push(e),g.push("?"),m.push(p))}var m=[],g=[],c=[],f={},k=[],h=this,d;for(d in a)a.hasOwnProperty(d)&&
(d in this.indices||d==this.idProperty?b(d,a[d]):f[d]=a[d]);for(d in this.indices)-1<d.indexOf(".")&&b(t(d),y(a,d),d);c.push("__extra");g.push("?");m.push(JSON.stringify(f));var n=this.idProperty;this.identifyGeneratedKey&&(m.idColumn=n);f="INSERT INTO "+this.table+" ("+c.join(",")+") VALUES ("+g.join(",")+")";return u(this.executeSql(f,m),function(e){var p=h.indices[n];if(p&&p.autoIncrement){var l=e.insertId;a[n]=l}else l=a[n];return v(k.map(function(q){return q(l)})).then(function(){return l})})},
put:function(a,b){function m(e,p,l){if(f.repeatingIndices[l||e])for(f.executeSql("DELETE FROM "+f.table+"_repeating_"+e+" WHERE id\x3d?",[g]),l=0;l<p.length;l++)f.executeSql("INSERT INTO "+f.table+"_repeating_"+e+" (value, id) VALUES (?, ?)",[p[l],g]);else h.push(e+"\x3d?"),k.push(p)}b=b||{};var g=b.id||a[this.idProperty],c=b.overwrite;if(void 0===c){var f=this;return this.get(g).then(function(e){return(b.overwrite=!!e)?(b.overwrite=!0,f.put(a,b)):f.add(a,b)})}if(!c)return f.add(a,b);c="UPDATE "+
this.table+" SET ";var k=[],h=[],d={};f=this;for(var n in a)a.hasOwnProperty(n)&&(n in this.indices||n==this.idProperty?m(n,a[n]):d[n]=a[n]);for(n in this.indices)-1<n.indexOf(".")&&m(t(n),y(a,n),n);h.push("__extra\x3d?");k.push(JSON.stringify(d));c+=h.join(",")+" WHERE "+this.idProperty+"\x3d?";k.push(a[this.idProperty]);return u(this.executeSql(c,k),function(){return g})},fetchRange:function(a){return this.fetch(a)},generateSql:function(){function a(e){if(e.match(/[^\w_\.]/))throw new URIError("Illegal column name "+
e);return d+"."+t(e)}function b(e){var p=e.args,l=p[0],q=p[1];switch(e.type){case "eq":case "ne":case "lt":case "lte":case "gt":case "gte":return n.push(q),[a(l),A[e.type]+"?"];case "and":case "or":l=[];for(q=0;q<p.length;q++)l.push(b(p[q]).join(""));return["(",l.join(A[e.type]),")"];case "in":return 0===q.length?"0\x3d1":q.generateSql?(e=q.generateSql(),n.push.apply(n,e.params),[a(l)," IN ("+e.select+e.from+")"]):[a(l)," IN ("+p[1].map(function(r){n.push(r);return"?"}).join(",")+")"];case "contains":var w=
d+"_repeating_"+l;return["(",q.map(function(r){r&&r.type?r="value "+b(r).slice(1).join(""):(n.push(r),r="value\x3d?");return a(h.idProperty)+" IN (SELECT id FROM "+w+" WHERE "+r+")"}).join(" AND "),")"];case "match":q=q.source;if("^"!==q[0]||q.match(/[\{\}\(\)\[\]\.,\$\*]/))throw Error("The match filter only supports simple prefix matching like /^starts with/");return[d+"."+l," LIKE '"+q.slice(1).replace(/'/g,"''")+"%'"];default:throw new URIError("Invalid query syntax, "+e.type+" not implemented");
}}var m="FROM "+this.table,g="",c="",f="*",k,h=this,d=this.table,n=[];this.queryLog.forEach(function(e){if("filter"===e.type)g=(g?" AND ":"")+b(e.normalizedArguments[0]).join("");else if("sort"===e.type)c=" ORDER BY "+e.normalizedArguments[0].map(function(q){return a(q.property)+" "+(q.descending?"desc":"asc")}).join(",");else if("select"===e.type){var p=e.normalizedArguments[0];if(p instanceof Array){for(var l=0;l<p.length;l++)if(!(p[l]in h.indices)){k=e;return}f=p.map(a).join(", ")}else p in h.indices&&
(f=a(p)),k=e}});g&&(g=" WHERE "+g);return{select:"SELECT "+f+" ",from:m+g+c,params:n,querier:k&&k.querier}},fetch:function(a){a=a||{};var b=this.generateSql(),m=b.from,g=b.params,c=b.querier;b=b.select+" "+m;a.end&&(b+=" LIMIT "+(a.end-(a.start||0)));a.start&&(b+=" OFFSET "+a.start);var f=this;a=x.delegate(this.executeSql(b,g).then(function(k){for(var h=[],d=0;d<k.rows.length;d++)h.push(f._restore(z(k.rows.item(d))));c&&(h=c(h));return h}));f=this;return new D(a,{totalLength:{then:function(k,h){return f.executeSql("SELECT COUNT(*) "+
m,g).then(function(d){return d.rows.item(0)["COUNT(*)"]}).then(k,h)}}})},executeSql:function(a,b){var m=new C,g,c;this.database.transaction(function(f){f.executeSql(a,b,function(k,h){m.resolve(g=h)},function(k,h){m.reject(c=h)})});if(g)return g;if(c)throw c;return m.promise}})});
//# sourceMappingURL=SQL.js.map