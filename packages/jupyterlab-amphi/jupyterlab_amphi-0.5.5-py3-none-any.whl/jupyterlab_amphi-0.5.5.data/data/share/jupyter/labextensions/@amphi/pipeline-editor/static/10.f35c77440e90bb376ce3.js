"use strict";(self.webpackChunk_amphi_pipeline_editor=self.webpackChunk_amphi_pipeline_editor||[]).push([[10],{2010:(e,t,n)=>{n.r(t),n.d(t,{IPipelineTracker:()=>G,default:()=>X});var o=n(974),a=n(2607),i=n(1130),s=n(765),r=n(9360),c=n(4586),l=n(7656),d=n(6089),p=n(7262),m=n(1631),u=n(3254),g=n(1355);const h='<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="16"\n   height="16"\n   fill="none"\n   viewBox="0 0 16 16"\n   version="1.1"\n   id="svg1"\n   sodipodi:docname="pipeline-brand-16.svg"\n   inkscape:version="1.3 (0e150ed, 2023-07-21)"\n   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"\n   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <defs\n     id="defs1" />\n  <sodipodi:namedview\n     id="namedview1"\n     pagecolor="#505050"\n     bordercolor="#eeeeee"\n     borderopacity="1"\n     inkscape:showpageshadow="0"\n     inkscape:pageopacity="0"\n     inkscape:pagecheckerboard="0"\n     inkscape:deskcolor="#505050"\n     inkscape:zoom="14.75"\n     inkscape:cx="8"\n     inkscape:cy="7.9661017"\n     inkscape:window-width="1512"\n     inkscape:window-height="874"\n     inkscape:window-x="0"\n     inkscape:window-y="32"\n     inkscape:window-maximized="1"\n     inkscape:current-layer="svg1" />\n  <path\n     fill="currentColor"\n     fill-rule="evenodd"\n     d="M2.75 2.5A1.75 1.75 0 001 4.25v1C1 6.216 1.784 7 2.75 7h1a1.75 1.75 0 001.732-1.5H6.5a.75.75 0 01.75.75v3.5A2.25 2.25 0 009.5 12h1.018c.121.848.85 1.5 1.732 1.5h1A1.75 1.75 0 0015 11.75v-1A1.75 1.75 0 0013.25 9h-1a1.75 1.75 0 00-1.732 1.5H9.5a.75.75 0 01-.75-.75v-3.5A2.25 2.25 0 006.5 4H5.482A1.75 1.75 0 003.75 2.5h-1zM2.5 4.25A.25.25 0 012.75 4h1a.25.25 0 01.25.25v1a.25.25 0 01-.25.25h-1a.25.25 0 01-.25-.25v-1zm9.75 6.25a.25.25 0 00-.25.25v1c0 .138.112.25.25.25h1a.25.25 0 00.25-.25v-1a.25.25 0 00-.25-.25h-1z"\n     clip-rule="evenodd"\n     id="path1"\n     style="fill:#5a8f7b;fill-opacity:1" />\n</svg>\n',w=(new g.LabIcon({name:"amphi:file-text-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><g fill="currentColor"><path d="M7.75 12a.75.75 0 000 1.5h8a.75.75 0 000-1.5h-8zM7 16.75a.75.75 0 01.75-.75h6a.75.75 0 010 1.5h-6a.75.75 0 01-.75-.75zM7.75 8a.75.75 0 000 1.5h2a.75.75 0 000-1.5h-2z"/><path fill-rule="evenodd" d="M3 3.75A2.75 2.75 0 015.75 1h7.586c.464 0 .909.184 1.237.513l5.914 5.914c.329.328.513.773.513 1.237V20.25A2.75 2.75 0 0118.25 23H5.75A2.75 2.75 0 013 20.25V3.75zM5.75 2.5c-.69 0-1.25.56-1.25 1.25v16.5c0 .69.56 1.25 1.25 1.25h12.5c.69 0 1.25-.56 1.25-1.25V9h-5.75a.75.75 0 01-.75-.75V2.5H5.75zm8.75 1.06l3.94 3.94H14.5V3.56z" clip-rule="evenodd"/></g></svg>'}),new g.LabIcon({name:"amphi:file-plus-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><g fill="currentColor"><path d="M11.75 10.75a.75.75 0 01.75.75V14H15a.75.75 0 010 1.5h-2.5V18a.75.75 0 01-1.5 0v-2.5H8.5a.75.75 0 010-1.5H11v-2.5a.75.75 0 01.75-.75z"/><path fill-rule="evenodd" d="M5.75 1A2.75 2.75 0 003 3.75v16.5A2.75 2.75 0 005.75 23h12.5A2.75 2.75 0 0021 20.25V8.664c0-.464-.184-.909-.513-1.237l-5.914-5.914A1.75 1.75 0 0013.336 1H5.75zM4.5 3.75c0-.69.56-1.25 1.25-1.25H13v5.75c0 .414.336.75.75.75h5.75v11.25c0 .69-.56 1.25-1.25 1.25H5.75c-.69 0-1.25-.56-1.25-1.25V3.75zM18.44 7.5L14.5 3.56V7.5h3.94z" clip-rule="evenodd"/></g></svg>'}),new g.LabIcon({name:"amphi:monitor-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M1 4.75A2.75 2.75 0 013.75 2h16.5A2.75 2.75 0 0123 4.75v10.5A2.75 2.75 0 0120.25 18H12.5v2.5H16a.75.75 0 010 1.5H8a.75.75 0 010-1.5h3V18H3.75A2.75 2.75 0 011 15.25V4.75zM20.25 16.5c.69 0 1.25-.56 1.25-1.25V4.75c0-.69-.56-1.25-1.25-1.25H3.75c-.69 0-1.25.56-1.25 1.25v10.5c0 .69.56 1.25 1.25 1.25h16.5z" clip-rule="evenodd"/></svg>'}),new g.LabIcon({name:"amphi:api-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M2 5a3 3 0 115.585 1.524l1.79 1.79.68-.68a2.75 2.75 0 013.89 0l.68.68 1.79-1.79a3 3 0 111.06 1.06l-1.79 1.791.681.68a2.75 2.75 0 010 3.89l-.68.68 1.79 1.79a3 3 0 11-1.06 1.06l-1.791-1.79-.68.681a2.75 2.75 0 01-3.89 0l-.68-.68-1.79 1.79a3 3 0 11-1.06-1.06l1.79-1.791-.681-.68a2.75 2.75 0 010-3.89l.68-.68-1.79-1.79A3 3 0 012 5zm3-1.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3zm0 14a1.5 1.5 0 100 3 1.5 1.5 0 000-3zM17.5 19a1.5 1.5 0 113 0 1.5 1.5 0 01-3 0zM19 3.5a1.5 1.5 0 100 3 1.5 1.5 0 000-3zm-7.884 5.195a1.25 1.25 0 011.768 0l2.421 2.421a1.25 1.25 0 010 1.768l-2.421 2.421a1.25 1.25 0 01-1.768 0l-2.421-2.421a1.25 1.25 0 010-1.768l2.421-2.421z" clip-rule="evenodd"/></svg>'}),new g.LabIcon({name:"amphi:pipeline-icon",svgstr:h})),v=new g.LabIcon({name:"amphi:component-icon",svgstr:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M7 9.25A2.75 2.75 0 019.75 6.5h5a2.75 2.75 0 012.75 2.75V11h4.75a.75.75 0 010 1.5H17.5v1.75A2.75 2.75 0 0114.75 17h-5A2.75 2.75 0 017 14.25V12.5H2.25a.75.75 0 010-1.5H7V9.25zm9 0C16 8.56 15.44 8 14.75 8h-5c-.69 0-1.25.56-1.25 1.25v5c0 .69.56 1.25 1.25 1.25h5c.69 0 1.25-.56 1.25-1.25v-5z" clip-rule="evenodd"/></svg>'}),f=new g.LabIcon({name:"amphi:pipelinenegative-icon",svgstr:h}),y=new g.LabIcon({name:"amphi:pipelineCategory-icon",svgstr:'<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n<svg\n   width="24"\n   height="24"\n   fill="none"\n   viewBox="0 0 24 24"\n   version="1.1"\n   id="svg1"\n   sodipodi:docname="pipeline-brand-24.svg"\n   inkscape:version="1.3 (0e150ed, 2023-07-21)"\n   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"\n   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"\n   xmlns="http://www.w3.org/2000/svg"\n   xmlns:svg="http://www.w3.org/2000/svg">\n  <defs\n     id="defs1" />\n  <sodipodi:namedview\n     id="namedview1"\n     pagecolor="#505050"\n     bordercolor="#eeeeee"\n     borderopacity="1"\n     inkscape:showpageshadow="0"\n     inkscape:pageopacity="0"\n     inkscape:pagecheckerboard="0"\n     inkscape:deskcolor="#505050"\n     inkscape:zoom="9.8333333"\n     inkscape:cx="12"\n     inkscape:cy="11.949153"\n     inkscape:window-width="1512"\n     inkscape:window-height="874"\n     inkscape:window-x="0"\n     inkscape:window-y="32"\n     inkscape:window-maximized="1"\n     inkscape:current-layer="svg1" />\n  <path\n     fill="currentColor"\n     fill-rule="evenodd"\n     d="M4.75 4.5A2.25 2.25 0 002.5 6.75v1A2.25 2.25 0 004.75 10h1a2.25 2.25 0 002.236-2H9.82c.967 0 1.75.784 1.75 1.75v4.5a3.25 3.25 0 003.25 3.25h1.195a2.25 2.25 0 002.236 2h1a2.25 2.25 0 002.25-2.25v-1A2.25 2.25 0 0019.25 14h-1a2.25 2.25 0 00-2.236 2h-1.195a1.75 1.75 0 01-1.75-1.75v-4.5A3.25 3.25 0 009.82 6.5H7.986a2.25 2.25 0 00-2.236-2h-1zM4 6.75A.75.75 0 014.75 6h1a.75.75 0 01.75.75v1a.75.75 0 01-.75.75h-1A.75.75 0 014 7.75v-1zm14.25 8.75a.75.75 0 00-.75.75v1c0 .414.336.75.75.75h1a.75.75 0 00.75-.75v-1a.75.75 0 00-.75-.75h-1z"\n     clip-rule="evenodd"\n     id="path1"\n     style="fill:#5a8f7b;fill-opacity:1" />\n</svg>\n'});var x=n(9994),b=n(5256),C=n(3345),k=n.n(C),E=n(5593),S=n.n(E),P=n(7832);const D=function({pipelineName:e,pipelineId:t}){const{getNodes:n}=(0,E.useReactFlow)();return k().createElement(E.ControlButton,{onClick:()=>{(0,E.getNodesBounds)(n());const o=document.querySelector(`.reactflow-wrapper[data-id="${t}"] .react-flow__viewport`);if(o instanceof HTMLElement){const{width:t,height:n}=o.getBoundingClientRect();(0,P.toSvg)(o,{backgroundColor:"#ffffff",width:t,height:n}).then((t=>function(e,t){const n=t.replace(/[^a-z0-9]/gi,"_").toLowerCase(),o=document.createElement("a");o.setAttribute("download",`${n}.svg`),o.setAttribute("href",e),o.click()}(t,e)))}}},"E")},I={maxHistorySize:100,enableShortcuts:!0};var A=n(2465),F=n(4810),N=n(4393);const{DirectoryTree:R}=F.Tree,{Search:B}=F.Input,z=({componentService:e})=>{const[t,n]=(0,C.useState)(""),[o,a]=(0,C.useState)([]),[i,s]=(0,C.useState)(!0),[r,c]=(0,C.useState)([]);(0,C.useEffect)((()=>{const t=e.getComponents();c(t),console.log("Fetched components:",t)}),[e]);const l=(e,t,n)=>{e.dataTransfer.setData("application/reactflow",t),e.dataTransfer.setData("additionalData",n),e.dataTransfer.effectAllowed="move"},d=(0,C.useMemo)((()=>{const e={};return r.forEach((t=>{let[n,o]=t._category.split(".");e[n]||(e[n]={}),o?(e[n][o]||(e[n][o]=[]),e[n][o].push(t)):(e[n]._||(e[n]._=[]),e[n]._.push(t))})),console.log("Categorized components:",e),e}),[r]),p=(e,t)=>{console.log("Filtering tree with search value:",t);const n=e.map((e=>{const n={...e};return n.children&&(n.children=p(n.children,t)),n.title.props.children.toLowerCase().includes(t.toLowerCase())||n.children&&n.children.length>0?n:null})).filter((e=>null!==e));return console.log("Filtered data:",n),n},m=(0,C.useMemo)((()=>Object.keys(d).map(((e,t)=>{const n=Object.keys(d[e]);let o=[];return n.forEach(((n,a)=>{"_"===n?o.push(...d[e][n].map(((e,n)=>({title:k().createElement("span",{draggable:!0,className:"palette-component",onDragStart:t=>l(t,e._id,e.getDefaultConfig?e.getDefaultConfig():""),key:`category-${t}-item-${n}`},e._name),key:`category-${t}-item-${n}`,isLeaf:!0,icon:k().createElement("span",{className:"anticon"},k().createElement(e._icon.react,{height:"14px",width:"14px;"}))})))):o.push({title:k().createElement("span",{className:"palette-component-category"},n.charAt(0).toUpperCase()+n.slice(1)),key:`category-${t}-sub-${a}`,children:d[e][n].map(((e,n)=>({title:k().createElement("span",{draggable:!0,className:"palette-component",onDragStart:t=>l(t,e._id,e.getDefaultConfig?e.getDefaultConfig():""),key:`category-${t}-sub-${a}-item-${n}`},e._name),key:`category-${t}-sub-${a}-item-${n}`,isLeaf:!0,icon:k().createElement("span",{className:"anticon"},k().createElement(e._icon.react,{height:"14px",width:"14px;"}))})))})})),{title:k().createElement("span",{className:"palette-component-category"},e.charAt(0).toUpperCase()+e.slice(1)),key:`category-${t}`,children:o}}))),[d]),u=(0,C.useMemo)((()=>t&&t.trim()?(console.log("Filter applied:",t),p(m,t)):(console.log("No filter applied"),m)),[t,m]);return(0,C.useEffect)((()=>{const e=t=>t.reduce(((t,n)=>(t.push(n.key),n.children&&t.push(...e(n.children)),t)),[]),n=t?e(u):Object.keys(d).map(((e,t)=>`category-${t}`));a(n)}),[t,u,d]),k().createElement("aside",{className:"sidebar",title:"Components"},k().createElement(F.Space,{direction:"vertical",style:{marginTop:"10px",marginLeft:"10px",width:"90%",textAlign:"center"}},k().createElement(F.Input,{placeholder:"Search components",onChange:e=>{const{value:t}=e.target;n(t),s(!0)},style:{marginBottom:8},suffix:k().createElement(N.A,{style:{color:"rgba(0,0,0,.25)"}})})),k().createElement(R,{selectable:!1,multiple:!0,blockNode:!0,autoExpandParent:i,expandedKeys:o,onExpand:e=>{a(e),s(!1)},treeData:u}))};function L({id:e,sourceX:t,sourceY:n,targetX:o,targetY:a,sourcePosition:i,targetPosition:s,style:r={},markerEnd:c}){const{setEdges:l}=(0,E.useReactFlow)(),[d,p,m]=(0,E.getBezierPath)({sourceX:t,sourceY:n,sourcePosition:i,targetX:o,targetY:a,targetPosition:s});return k().createElement(k().Fragment,null,k().createElement(E.BaseEdge,{path:d,markerEnd:c,style:r}),k().createElement(E.EdgeLabelRenderer,null,k().createElement("div",{style:{position:"absolute",transform:`translate(-50%, -50%) translate(${p}px,${m}px)`,fontSize:12,pointerEvents:"all"},className:"nodrag nopan"},k().createElement("button",{className:"edgebutton",onClick:()=>{l((t=>t.filter((t=>t.id!==e))))}},"×"))))}n(7576),n(1550);const T=({children:e,...t})=>{const{getRootProps:n}=(e=>{const t=(0,C.useRef)(null),n=(0,C.useCallback)((t=>{var n,o,a,i;switch(t.preventDefault(),t.stopPropagation(),t.type){case"lm-dragenter":null===(n=e.onDragEnter)||void 0===n||n.call(e,t);break;case"lm-dragleave":null===(o=e.onDragLeave)||void 0===o||o.call(e,t);break;case"lm-dragover":t.dropAction=t.proposedAction,null===(a=e.onDragOver)||void 0===a||a.call(e,t);break;case"lm-drop":null===(i=e.onDrop)||void 0===i||i.call(e,t)}}),[e]);return(0,C.useEffect)((()=>{const e=t.current;return null==e||e.addEventListener("lm-dragenter",n),null==e||e.addEventListener("lm-dragleave",n),null==e||e.addEventListener("lm-dragover",n),null==e||e.addEventListener("lm-drop",n),()=>{null==e||e.removeEventListener("lm-dragenter",n),null==e||e.removeEventListener("lm-dragleave",n),null==e||e.removeEventListener("lm-dragover",n),null==e||e.removeEventListener("lm-drop",n)}}),[n]),{getRootProps:()=>({ref:t})}})(t);return k().createElement("div",{style:{height:"100%"},...n()},e)};var _=n(7628),M=n.n(_),$=n(6271);n(502);const H=({code:e})=>k().createElement($.Ay,{width:"950px",height:"500px",mode:"python",theme:"xcode",name:"Code Export",fontSize:14,lineHeight:19,showPrintMargin:!0,showGutter:!0,highlightActiveLine:!0,value:e,setOptions:{enableBasicAutocompletion:!0,enableLiveAutocompletion:!0,enableSnippets:!0,showLineNumbers:!0,tabSize:2}});class O extends a.ReactWidget{constructor(e){super(),this.browserFactory=e.browserFactory,this.defaultFileBrowser=e.defaultFileBrowser,this.shell=e.shell,this.toolbarRegistry=e.toolbarRegistry,this.commands=e.commands,this.context=e.context,this.settings=e.settings,this.componentService=e.componentService;let t=null===this.context.model.toJSON();this.context.model.contentChanged.connect((()=>{t&&(t=!1,this.update())}))}render(){var e;return null===this.context.model.toJSON()?k().createElement("div",{className:"amphi-loader"}):k().createElement(V,{context:this.context,browserFactory:this.browserFactory,defaultFileBrowser:this.defaultFileBrowser,shell:this.shell,toolbarRegistry:this.toolbarRegistry,commands:this.commands,widgetId:null===(e=this.parent)||void 0===e?void 0:e.id,settings:this.settings,componentService:this.componentService})}}const V=({context:e,browserFactory:t,defaultFileBrowser:n,shell:o,toolbarRegistry:i,commands:s,settings:r,widgetId:c,componentService:l})=>{const d=n.model.manager,p={"custom-edge":L},m=l.getComponents().reduce(((t,n)=>{const o=n._id,a=t=>k().createElement(n.UIComponent,{context:e,componentService:l,manager:d,commands:s,settings:r,...t});return t[o]=t=>k().createElement(a,{context:e,componentService:l,manager:d,commands:s,...t}),t}),{}),g=()=>"node_"+ +new Date;return k().createElement("div",{className:"canvas",id:"pipeline-panel"},k().createElement(F.ConfigProvider,{theme:{token:{colorPrimary:"#5F9B97"}}},k().createElement(E.ReactFlowProvider,null,k().createElement((function(e){const t=(0,C.useRef)(null),[i,s]=(0,C.useState)(e.context.model.toJSON()),r=i.id,d=i.pipelines[0].flow.nodes,h=i.pipelines[0].flow.edges,w=i.pipelines[0].flow.viewport,[v,f,y]=(0,E.useNodesState)(d),[x,b,P]=(0,E.useEdgesState)(h),[F,N]=(0,C.useState)(null),{getViewport:R,setViewport:B}=(0,E.useReactFlow)(),z=(0,E.useStoreApi)(),{undo:L,redo:_,canUndo:M,canRedo:$,takeSnapshot:H}=(({maxHistorySize:e=I.maxHistorySize,enableShortcuts:t=I.enableShortcuts}=I)=>{const[n,o]=(0,C.useState)([]),[a,i]=(0,C.useState)([]),{setNodes:s,setEdges:r,getNodes:c,getEdges:l}=(0,E.useReactFlow)(),d=(0,C.useCallback)((()=>{o((t=>[...t.slice(t.length-e+1,t.length),{nodes:c(),edges:l()}])),i([])}),[c,l,e]),p=(0,C.useCallback)((()=>{const e=n[n.length-1];e&&(o((e=>e.slice(0,e.length-1))),i((e=>[...e,{nodes:c(),edges:l()}])),s(e.nodes),r(e.edges))}),[s,r,c,l,n]),m=(0,C.useCallback)((()=>{const e=a[a.length-1];e&&(i((e=>e.slice(0,e.length-1))),o((e=>[...e,{nodes:c(),edges:l()}])),s(e.nodes),r(e.edges))}),[s,r,c,l,a]);return(0,C.useEffect)((()=>{if(!t)return;const e=e=>{"z"===e.key&&(e.ctrlKey||e.metaKey)&&e.shiftKey?m():"z"===e.key&&(e.ctrlKey||e.metaKey)&&p()};return document.addEventListener("keydown",e),()=>{document.removeEventListener("keydown",e)}}),[p,m,t]),{undo:p,redo:m,takeSnapshot:d,canUndo:!n.length,canRedo:!a.length}})(),O=(0,C.useCallback)((()=>{H()}),[H]),V=(0,C.useCallback)((()=>{H()}),[H]),W=(0,C.useCallback)((()=>{H()}),[H]),K=i;K.pipelines[0].flow.nodes=v,K.pipelines[0].flow.edges=x,K.pipelines[0].flow.viewport=R(),e.context.model.fromJSON(K);const U=(0,C.useCallback)((e=>{H(),b((t=>(0,E.addEdge)({...e,type:"custom-edge"},t)))}),[b,H]),J=e=>{const t=v.find((t=>t.id===e));if(console.log("node %o",t),t)return l.getComponent(t.type)._type},j=(0,C.useCallback)((e=>{b(e.reduce(((e,t)=>{const n=(0,E.getIncomers)(t,v,x),o=(0,E.getOutgoers)(t,v,x),a=(0,E.getConnectedEdges)([t],x);return[...e.filter((e=>!a.includes(e))),...n.flatMap((({id:e})=>o.map((({id:t})=>({id:`${e}->${t}`,source:e,target:t,type:"custom-edge"})))))]}),x)),H()}),[v,x,H]),G=(0,C.useCallback)((t=>{var i;const s=n;if((null===(i=o.currentWidget)||void 0===i?void 0:i.id)===c&&F&&t){const{height:n,width:o,transform:[i,r,c]}=z.getState(),d=1/c,p={x:(t.x-i)*d,y:(t.y-r)*d};Array.from(s.selectedItems()).forEach((async t=>{const n=t.path,o=t.name.split(".").pop();if("amcpn"===o){const e=new A.ContentsManager;try{const t=await e.get(n);console.log("File %o:",t);const o=t.content;console.log("File Content:",o);const i=JSON.parse(o);console.log("fileData %o",i);const{type:s,data:r}=i.component;if(s&&r){const e={id:g(),type:s,position:p,data:{...r,lastUpdated:Date.now()}};f((t=>t.concat(e)))}else(0,a.showDialog)({title:"Invalid Component",body:"The selected file does not contain valid component data.",buttons:[a.Dialog.okButton()]})}catch(e){(0,a.showDialog)({title:"Error Reading File",body:"There was an error reading the file.",buttons:[a.Dialog.okButton()]})}return}const{id:i,default:s}=u.PipelineService.getComponentIdForFileExtension(o,l);if(i){const t={id:g(),type:i,position:p,data:{filePath:u.PipelineService.getRelativePath(e.context.sessionContext.path,n),lastUpdated:Date.now(),...s||{}}};f((e=>e.concat(t)))}else(0,a.showDialog)({title:"Unsupported File(s)",body:"Only supported files can be added to a pipeline.",buttons:[a.Dialog.okButton()]})}))}}),[n,o,c,F]),X=(0,C.useCallback)((e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"}),[]),Y=(0,C.useCallback)((e=>{H(),e.preventDefault();const n=t.current.getBoundingClientRect(),o=e.dataTransfer.getData("application/reactflow"),a=e.dataTransfer.getData("additionalData");if(void 0===o||!o)return;const i=F.project({x:e.clientX-n.left,y:e.clientY-n.top}),s={id:g(),type:o,position:i,data:{...a,lastUpdated:Date.now()}};f((e=>e.concat(s)))}),[F]);return(0,C.useCallback)((t=>{const n={...i};n.pipelines[0].flow.viewport=t,console.log("update viewport"),e.context.model.fromJSON(n)}),[i,e]),k().createElement("div",{className:"reactflow-wrapper","data-id":r,ref:t},k().createElement(T,{onDrop:async e=>{H(),G({x:e.offsetX,y:e.offsetY})}},k().createElement(S(),{id:r,nodes:v,edges:x,onNodesChange:y,onNodesDelete:j,onEdgesDelete:W,onEdgesChange:P,onConnect:U,onNodeDragStart:O,onSelectionDragStart:V,isValidConnection:e=>{const t=J(e.source),n=J(e.target);return"pandas_df_to_documents_processor"===t||t.startsWith("documents")?n.startsWith("documents"):!!t.startsWith("pandas_df")&&n.startsWith("pandas_df")},onDrop:Y,onDragOver:X,onInit:N,edgeTypes:p,nodeTypes:m,snapToGrid:!0,snapGrid:[15,15],fitViewOptions:{minZoom:.5,maxZoom:1},defaultViewport:w,deleteKeyCode:[]},k().createElement(E.Panel,{position:"top-right"}),k().createElement(E.Controls,null,k().createElement(D,{pipelineName:e.context.sessionContext.path,pipelineId:r})),k().createElement(E.Background,{color:"#aaa",gap:15}))))}),{context:e}),k().createElement(z,{componentService:l}))))};class W extends x.ABCWidgetFactory{constructor(e){super(e),this.browserFactory=e.browserFactory,this.defaultFileBrowser=e.defaultFileBrowser,this.shell=e.shell,this.toolbarRegistry=e.toolbarRegistry,this.commands=e.commands,this.settings=e.settings,this.componentService=e.componentService}createNewWidget(e){const t={shell:this.shell,toolbarRegistry:this.toolbarRegistry,commands:this.commands,browserFactory:this.browserFactory,defaultFileBrowser:this.defaultFileBrowser,context:e,settings:this.settings,componentService:this.componentService};let n=this.settings.get("enableExecution").composite;console.log(`Settings extension in PipelineEditor: enableExecution is set to '${n}'`),e.sessionContext.kernelPreference=n?{autoStartDefault:!0,name:"python",shutdownOnDispose:!1}:{shouldStart:!1,canStart:!1,shutdownOnDispose:!0};const o=new O(t),i=new x.DocumentWidget({content:o,context:e}),s=new a.ToolbarButton({label:"Save Pipeline",icon:g.saveIcon,onClick:()=>{this.commands.execute("docmanager:save")}});i.toolbar.addItem("save",s);const r=new a.ToolbarButton({label:"Export to Python code",iconLabel:"Export to Python code",icon:g.buildIcon,onClick:async()=>{!async function(t,n){const o=document.createElement("div");o.style.width="100%",o.style.height="500px";const i=new b.Widget({node:o});M().render(k().createElement(H,{code:t}),o);const s=await(0,a.showDialog)({title:"Generated Python Code",body:i,buttons:[a.Dialog.okButton({label:"Close"}),a.Dialog.createButton({label:"Open in new file",className:"",accept:!0})]});console.log("result %o",s),"Open in new file"===s.button.label&&(console.log("Before save as"),await(async()=>{console.log("Before file"),console.log("context %o",e);const o=await n.execute("docmanager:new-untitled",{path:"/",type:"file",ext:".py"});console.log("before doc"),(await n.execute("docmanager:open",{path:o.path})).context.model.fromString(t)})())}(await u.CodeGenerator.generateCode(e.model.toString(),this.commands,this.componentService),this.commands)}});i.toolbar.addItem("generateCode",r);const c=new a.ToolbarButton({label:"Run Pipeline",iconLabel:"Run Pipeline",icon:g.runIcon,onClick:async()=>{this.commands.execute("docmanager:save");const t=u.CodeGenerator.generateCode(e.model.toString(),this.commands,this.componentService);this.commands.execute("pipeline-editor:run-pipeline",{code:t}).catch((e=>{console.error(`An error occurred during the execution of 'pipeline-editor:run-pipeline'.\n${e}`)}))},enabled:n});i.toolbar.addItem("runPipeline",c);const l=new a.ToolbarButton({label:"Console",iconLabel:"Console",icon:g.listIcon,onClick:async()=>{const e="pipeline-console:open";this.commands.execute(e,{}).catch((t=>{console.error(`An error occurred during the execution of ${e}.\n${t}`)}))},enabled:n});i.toolbar.addItem("openlogconsole",l);const d=a.Toolbar.createKernelNameItem(t.context.sessionContext),p=g.Toolbar.createSpacerItem();return i.toolbar.addItem("spacer",p),i.toolbar.addItem("kernelName",d),i.addClass("amphi-PipelineEditor"),i.title.icon=w,i}}var K;!function(e){e.create="pipeline-editor:create-new",e.restartPipelineKernel="pipeline-editor:restart-kernel",e.runPipeline="pipeline-editor:run-pipeline",e.runPipelineUntil="pipeline-editor:run-pipeline-until"}(K||(K={}));const U="Pipeline Editor",J="amphi-pipeline",j="@amphi/pipeline-editor:extension",G=new p.Token("pipeline-editor-tracker"),X=[{id:j,autoStart:!0,requires:[a.ICommandPalette,l.IRenderMimeRegistry,r.ILauncher,c.IFileBrowserFactory,c.IDefaultFileBrowser,d.IStatusBar,o.ILayoutRestorer,i.IMainMenu,s.ISettingRegistry,a.IToolbarWidgetRegistry,a.ISessionContextDialogs,m.IDocumentManager,u.ComponentManager],provides:G,activate:(e,t,n,o,i,s,r,c,l,d,m,g,h,w)=>{console.log("Amphi Pipeline Extension activation...");const{commands:x}=e,b=K.create,C=new a.WidgetTracker({namespace:"amphi-pipeline-editor"});let k;function E(e){k=e.get("enableExecution").composite,console.log(`Settings extension: enableExecution is set to '${k}'`)}return Promise.all([e.restored,d.load(j)]).then((([,n])=>{E(n),n.changed.connect(E);const r=new W({name:U,fileTypes:[J],defaultFor:[J],canStartKernel:!0,preferKernel:!0,shutdownOnClose:!0,shell:e.shell,toolbarRegistry:m,commands:e.commands,browserFactory:i,defaultFileBrowser:s,serviceManager:e.serviceManager,settings:n,componentService:w});function c(t){const n=C.currentWidget;return!1!==t.activate&&n&&e.shell.activateById(n.id),null!=n?n:null}function l(){return null!==C.currentWidget&&C.currentWidget===e.shell.currentWidget}r.widgetCreated.connect(((e,t)=>{C.add(t),t.context.pathChanged.connect((()=>{C.save(t)}))})),e.docRegistry.addFileType({name:"amphi-pipeline",displayName:"pipeline",extensions:[".ampln"],icon:f,fileFormat:"text"},[U,"JSON"]),e.docRegistry.addWidgetFactory(r),e.docRegistry.addFileType({name:"amphi-component",displayName:"component",extensions:[".amcpn"],icon:v,fileFormat:"text"},["JSON"]),x.addCommand(b,{label:e=>(e.isPalette||e.isContextMenu,"New Pipeline"),caption:"Create a new pipeline",icon:e=>e.isPalette?null:y,execute:async t=>x.execute("docmanager:new-untitled",{type:"file",path:s.model.path,ext:".ampln"}).then((async t=>{const n={doc_type:"Amphi Pipeline",version:"1",json_schema:"http://docs.amphi.ai/schemas/pipeline-v1-schema.json",id:"pipeline_"+ +new Date,pipelines:[{id:"primary",flow:{nodes:[],edges:[],viewport:{x:0,y:0,zoom:1}},app_data:{ui_data:{comments:[]},version:1,runtime_type:"LOCAL"},runtime_ref:"python"}]},o=await e.commands.execute("docmanager:open",{path:t.path,factory:U});o.context.ready.then((()=>{o.context.model.fromJSON(n),e.commands.execute("docmanager:save",{path:t.path})}))}))}),x.addCommand(K.restartPipelineKernel,{label:"Restart Runtime…",execute:async e=>{const t=c({activate:!1,...e});if(t){console.log(t.context.sessionContext);try{await t.context.sessionContext.restartKernel()}catch(e){console.error("Failed to restart runtime: ",e)}}},isEnabled:l}),x.addCommand(K.runPipeline,{label:"Run Pipeline",execute:e=>{if(e.datapanel){const e="metadatapanel:open";x.execute(e,{}).catch((t=>{console.error(`An error occurred during the execution of ${e}.\n${t}`)}))}else x.execute("pipeline-console:open",{}).catch((e=>{console.error(`An error occurred during the execution of ${b}.\n${e}`)}));const t=c(e);t&&(t.context.sessionContext.session?t.context.sessionContext.hasNoKernel?a.Notification.error("The pipeline cannot be run because no processing engine can be found.",{actions:[{label:"Try to reload the application and run again.",callback:()=>location.reload()}],autoClose:6e3}):t.context.sessionContext?(t.context.sessionContext.ready.then((async()=>{const n=e.code.toString();let o;const a=u.PipelineService.extractPythonImportPackages(n);o=u.PipelineService.extractPackageNames(a);const i=n.split(/\r?\n/)[2],s=i.startsWith("# Additional dependencies: ")?i.split(": ")[1].split(",").map((e=>e.trim())):[];if(o=[...o,...s],o.length>0&&null!=o[0]&&""!==o[0]){const e=u.PipelineService.getInstallCommandsFromPackageNames(o).join("\n");console.log("pips_code: "+e);try{const n=t.context.sessionContext.session.kernel.requestExecute({code:e});n.onIOPub=e=>{if("stream"===e.header.msg_type);else if("error"===e.header.msg_type){const t=e.content;console.error(`Received error: ${t.ename}: ${t.evalue}`)}},n.onDone=()=>{console.log("Dependencies installed.")},await n.done}catch(e){console.error(e)}}})),t.context.sessionContext.ready.then((async()=>{try{const n=new p.PromiseDelegate,o=performance.now();a.Notification.promise(n.promise,{pending:{message:"Running...",options:{autoClose:!1}},success:{message:e=>`Pipeline execution successful after ${e.delayInSeconds} seconds.`,options:{autoClose:3e3}},error:{message:()=>"Pipeline execution failed. Check error messages in the Log Console.",options:{actions:[{label:"Log Console",callback:()=>{const e="pipeline-console:open";x.execute(e,{}).catch((t=>{console.error(`An error occurred during the execution of ${e}.\n${t}`)}))}}],autoClose:5e3}}});const i=t.context.sessionContext.session.kernel.requestExecute({code:e.code});console.log("future %o",i),i.onReply=e=>{const t=((performance.now()-o)/1e3).toFixed(1);"ok"===e.content.status?n.resolve({delayInSeconds:t}):n.reject({delayInSeconds:t})},i.onIOPub=e=>{if("stream"===e.header.msg_type);else if("error"===e.header.msg_type){const t=e.content;console.error(`Received error: ${t.ename}: ${t.evalue}`)}},i.onDone=()=>{const e=((performance.now()-o)/1e3).toFixed(1);n.resolve({delayInSeconds:e})},await i.done}catch(e){console.error(e)}}))):a.Notification.error("The pipeline cannot be run because the local Python engine cannot be found.",{actions:[{label:"Try to reload the application and run again.",callback:()=>location.reload()}],autoClose:6e3}):a.Notification.error("The pipeline cannot be run because the local Python engine cannot be found.",{actions:[{label:"Try to reload the application and run again.",callback:()=>location.reload()}],autoClose:6e3}))},isEnabled:l}),x.addCommand("pipeline-editor:run-pipeline-until",{label:"Run pipeline until ...",execute:async e=>{const t=c(e);if(!t)return;const n=e.nodeId.toString(),o=e.context,a=u.CodeGenerator.generateCodeUntil(t.context.model.toString(),x,w,n,o);x.execute("pipeline-editor:run-pipeline",{code:a}).catch((e=>{console.error(`An error occurred during the execution of 'pipeline-editor:run-pipeline'.\n${e}`)}))}}),e.contextMenu.addItem({command:K.create,selector:".jp-DirListing-content",rank:100}),t.addItem({command:K.create,category:"Pipeline",args:{isPalette:!0}}),x.addCommand("pipeline-editor-component:save-as-file",{execute:async t=>{const n=c(t);if(!n)return;const o=e.contextMenuHitTest((e=>!!e.dataset.id));if(o){const e=o.dataset.id,t=u.PipelineService.getNodeById(n.context.model.toString(),e),{data:a,type:i}=t,{lastUpdated:s,lastExecuted:r,...c}=a,l=JSON.stringify({component:{data:c,type:i}}),d=await x.execute("docmanager:new-untitled",{path:"/",type:"file",ext:".amcpn"}),p=await x.execute("docmanager:open",{path:d.path});await p.context.ready,p.context.model.fromString(l),await p.context.save(),await x.execute("docmanager:reload",{path:d.path}),await x.execute("docmanager:rename")}},label:"Save as file"}),x.addCommand("pipeline-editor-component:copy",{execute:async t=>{const n=e.contextMenuHitTest((e=>!!e.dataset.id));if(n){const e=n.getAttribute("data-id");console.log(e)}},label:"Copy"}),x.addCommand("pipeline-editor-component:cut",{execute:t=>{const n=e.contextMenuHitTest((e=>!!e.dataset.id));n&&console.log(n)},label:"Cut"}),x.addCommand("pipeline-editor-component:paste",{execute:async e=>{},label:"Paste"}),[{command:"pipeline-editor-component:save-as-file",selector:".component",rank:3}].forEach((t=>{e.contextMenu.addItem({command:t.command,selector:t.selector,rank:t.rank})})),o&&o.add({command:K.create,category:"Amphi",rank:3})})).catch((e=>{console.error(`Something went wrong when reading the settings.\n${e}`)})),c&&c.restore(C,{command:"docmanager:open",args:e=>({path:e.context.path,factory:U}),name:e=>e.context.path}),C}}]}}]);