from re import search
from string import hexdigits
from threading import Timer
from nbtools import ToolManager, DataManager

GALAXY_SERVERS = {
    'Galaxy Main': 'https://usegalaxy.org',
    'Galaxy EU': 'https://usegalaxy.eu',
    'Galaxy AU': 'https://usegalaxy.org.au',
}


GALAXY_COLORS = [(44, 49, 67, 0.80),
                 (0, 51, 153, 0.80),
                 (206, 188, 44, 0.80),
                 (222, 226, 230, 0.80), ]


GALAXY_LOGO = 'data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8+CjxzdmcKICAgeG1sbnM6ZGM9Imh0dHA6Ly9wdXJsLm9yZy9kYy9lbGVtZW50cy8xLjEvIgogICB4bWxuczpjYz0iaHR0cDovL2NyZWF0aXZlY29tbW9ucy5vcmcvbnMjIgogICB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiCiAgIHhtbG5zOnN2Zz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciCiAgIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIKICAgeG1sbnM6c29kaXBvZGk9Imh0dHA6Ly9zb2RpcG9kaS5zb3VyY2Vmb3JnZS5uZXQvRFREL3NvZGlwb2RpLTAuZHRkIgogICB4bWxuczppbmtzY2FwZT0iaHR0cDovL3d3dy5pbmtzY2FwZS5vcmcvbmFtZXNwYWNlcy9pbmtzY2FwZSIKICAgdmVyc2lvbj0iMS4xIgogICBpZD0iTGF5ZXJfMSIKICAgeD0iMHB4IgogICB5PSIwcHgiCiAgIHZpZXdCb3g9IjAgMCA2ODUuMjk5OTkgMjA3LjgiCiAgIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDYxMiAxOTQiCiAgIHhtbDpzcGFjZT0icHJlc2VydmUiCiAgIHNvZGlwb2RpOmRvY25hbWU9ImZhdmljb24uc3ZnIgogICBpbmtzY2FwZTp2ZXJzaW9uPSIxLjAuMSAoYzQ5N2IwM2MsIDIwMjAtMDktMTApIgogICB3aWR0aD0iNjg1LjI5OTk5IgogICBoZWlnaHQ9IjIwNy44Ij48bWV0YWRhdGEKICAgaWQ9Im1ldGFkYXRhNDI2NSI+PHJkZjpSREY+PGNjOldvcmsKICAgICAgIHJkZjphYm91dD0iIj48ZGM6Zm9ybWF0PmltYWdlL3N2Zyt4bWw8L2RjOmZvcm1hdD48ZGM6dHlwZQogICAgICAgICByZGY6cmVzb3VyY2U9Imh0dHA6Ly9wdXJsLm9yZy9kYy9kY21pdHlwZS9TdGlsbEltYWdlIiAvPjxkYzp0aXRsZT48L2RjOnRpdGxlPjwvY2M6V29yaz48L3JkZjpSREY+PC9tZXRhZGF0YT48ZGVmcwogICBpZD0iZGVmczQyNjMiIC8+PHNvZGlwb2RpOm5hbWVkdmlldwogICBwYWdlY29sb3I9IiNmZmZmZmYiCiAgIGJvcmRlcmNvbG9yPSIjNjY2NjY2IgogICBib3JkZXJvcGFjaXR5PSIxIgogICBvYmplY3R0b2xlcmFuY2U9IjEwIgogICBncmlkdG9sZXJhbmNlPSIxMCIKICAgZ3VpZGV0b2xlcmFuY2U9IjEwIgogICBpbmtzY2FwZTpwYWdlb3BhY2l0eT0iMCIKICAgaW5rc2NhcGU6cGFnZXNoYWRvdz0iMiIKICAgaW5rc2NhcGU6d2luZG93LXdpZHRoPSIxNDIzIgogICBpbmtzY2FwZTp3aW5kb3ctaGVpZ2h0PSI4MzAiCiAgIGlkPSJuYW1lZHZpZXc0MjYxIgogICBzaG93Z3JpZD0iZmFsc2UiCiAgIGlua3NjYXBlOnBhZ2VjaGVja2VyYm9hcmQ9InRydWUiCiAgIGlua3NjYXBlOnpvb209IjEuMDU0MzI3MyIKICAgaW5rc2NhcGU6Y3g9IjM0MS4zNDcwNSIKICAgaW5rc2NhcGU6Y3k9IjExNS41NDIwNCIKICAgaW5rc2NhcGU6d2luZG93LXg9IjI3NyIKICAgaW5rc2NhcGU6d2luZG93LXk9IjI1IgogICBpbmtzY2FwZTp3aW5kb3ctbWF4aW1pemVkPSIwIgogICBpbmtzY2FwZTpjdXJyZW50LWxheWVyPSJMYXllcl8xIgogICBpbmtzY2FwZTpzaG93cGFnZXNoYWRvdz0iMiIKICAgaW5rc2NhcGU6ZGVza2NvbG9yPSIjZDFkMWQxIgogICBpbmtzY2FwZTpkb2N1bWVudC1yb3RhdGlvbj0iMCIKICAgZml0LW1hcmdpbi10b3A9IjQwIgogICBsb2NrLW1hcmdpbnM9InRydWUiCiAgIGZpdC1tYXJnaW4tbGVmdD0iNDAiCiAgIGZpdC1tYXJnaW4tcmlnaHQ9IjQwIgogICBmaXQtbWFyZ2luLWJvdHRvbT0iNDAiCiAgIHNob3dndWlkZXM9ImZhbHNlIiAvPgo8Zm9udAogICBob3Jpei1hZHYteD0iMTAwMCIKICAgaWQ9ImZvbnQ0MjMxIgogICBob3Jpei1vcmlnaW4teD0iMCIKICAgaG9yaXotb3JpZ2luLXk9IjAiCiAgIHZlcnQtb3JpZ2luLXg9IjUxMiIKICAgdmVydC1vcmlnaW4teT0iNzY4IgogICB2ZXJ0LWFkdi15PSIxMDI0Ij4KPCEtLSBDb3B5cmlnaHQgKGMpIDIwMTEgTmF0YW5hZWwgR2FtYSAoZXhvQG5kaXNjb3ZlcmVkLmNvbSksIHdpdGggUmVzZXJ2ZWQgRm9udCBOYW1lICZxdW90O0V4byZxdW90OyAtLT4KPCEtLSBDb3B5cmlnaHQ6IENvcHlyaWdodCAyMDE2IEFkb2JlIFN5c3RlbSBJbmNvcnBvcmF0ZWQuIEFsbCByaWdodHMgcmVzZXJ2ZWQuIC0tPgo8Zm9udC1mYWNlCiAgIGZvbnQtZmFtaWx5PSJFeG8tRXh0cmFMaWdodCIKICAgdW5pdHMtcGVyLWVtPSIxMDAwIgogICB1bmRlcmxpbmUtcG9zaXRpb249Ii03NSIKICAgdW5kZXJsaW5lLXRoaWNrbmVzcz0iNTAiCiAgIGlkPSJmb250LWZhY2U0MjA1IiAvPgo8bWlzc2luZy1nbHlwaAogICBob3Jpei1hZHYteD0iNzg0IgogICBkPSJNNjU3LDUwNmwtMjUyLC0yNDBsMjUyLC0yNDFNMTQwLDEzbDUwNywwbC0yNTMsMjQzTTEyNywyMmwyNTYsMjQ0bC0yNTYsMjQxTTY0OCw1MThsLTUxMSwwbDI1NywtMjQyTTExMywwbDAsNTMxbDU1OCwwbDAsLTUzMXoiCiAgIGlkPSJtaXNzaW5nLWdseXBoNDIwNyIgLz4KPGdseXBoCiAgIHVuaWNvZGU9IiAiCiAgIGhvcml6LWFkdi14PSIyNjkiCiAgIGlkPSJnbHlwaDQyMDkiIC8+CjxnbHlwaAogICB1bmljb2RlPSJCIgogICBob3Jpei1hZHYteD0iNTk3IgogICBkPSJNOTgsMGwwLDczMmwyNjMsMEM0MjksNzMyIDQ3OCw3MTUgNTA3LDY4MUM1MzYsNjQ3IDU1MSw2MDUgNTUxLDU1NkM1NTEsNTA3IDU0MCw0NjcgNTE5LDQzN0M0OTcsNDA3IDQ2OSwzODkgNDM1LDM4M0M0NjMsMzc2IDQ5MCwzNTggNTE2LDMyN0M1NDIsMjk2IDU1NSwyNTUgNTU1LDIwNEM1NTUsMTQ4IDU0MiwxMDEgNTE2LDY0QzQ4NiwyMSA0MzQsMCAzNjEsME0xNDAsNDJsMjIxLDBDNDYzLDQyIDUxNCw5NyA1MTQsMjA2QzUxNCwyNTAgNTAwLDI4NyA0NzEsMzE3QzQ0MiwzNDcgNDA3LDM2MiAzNjQsMzYyQzM2MywzNjIgMzYyLDM2MiAzNjEsMzYybC0yMjEsME0xNDAsNDA0bDIyMSwwQzQwNiw0MDQgNDQxLDQxNyA0NjgsNDQyQzQ5Niw0NjcgNTEwLDUwNSA1MTAsNTU0QzUxMCw2NDUgNDYwLDY5MSAzNjEsNjkxbC0yMjEsMHoiCiAgIGlkPSJnbHlwaDQyMTEiIC8+CjxnbHlwaAogICB1bmljb2RlPSJDIgogICBob3Jpei1hZHYteD0iNTcyIgogICBkPSJNNjgsMzY4QzY4LDUyMSA5MSw2MjQgMTM4LDY3NkMxNzcsNzE5IDIzNCw3NDAgMzExLDc0MEMzNzQsNzQwIDQ0OSw3MzIgNTM1LDcxNmwwLC0zMEM1MjQsNjg3IDUxNSw2ODggNTA2LDY4OUM0OTcsNjkwIDQ4Nyw2OTAgNDc2LDY5MUM0NjQsNjkyIDQ1MSw2OTMgNDM4LDY5NEM0MjQsNjk1IDQxMCw2OTUgMzk2LDY5NkMzNzMsNjk4IDM0MCw2OTkgMjk5LDY5OUMyNTgsNjk5IDIyMyw2OTAgMTk1LDY3MkMxMzgsNjM0IDEwOSw1MzIgMTA5LDM2NkMxMDksMTQ1IDE3NywzNSAzMTIsMzVDMzc0LDM1IDQzNywzNyA1MDIsNDJsMzMsM2wwLC0yOUM0NTYsMSAzODIsLTYgMzExLC02QzE0OSwtNiA2OCwxMTkgNjgsMzY4eiIKICAgaWQ9ImdseXBoNDIxMyIgLz4KPGdseXBoCiAgIHVuaWNvZGU9IkgiCiAgIGhvcml6LWFkdi14PSI2NTUiCiAgIGQ9Ik05OCwwbDAsNzMybDQxLDBsMCwtMzU4bDQxMCwwbDAsMzU4bDQxLDBsMCwtNzMybC00MSwwbDAsMzM0bC00MTAsMGwwLC0zMzR6IgogICBpZD0iZ2x5cGg0MjE1IiAvPgo8Z2x5cGgKICAgdW5pY29kZT0iSSIKICAgaG9yaXotYWR2LXg9IjIwNCIKICAgZD0iTTk4LDBsMCw3MzJsNDEsMGwwLC03MzJ6IgogICBpZD0iZ2x5cGg0MjE3IiAvPgo8Z2x5cGgKICAgdW5pY29kZT0iTSIKICAgaG9yaXotYWR2LXg9Ijc5OCIKICAgZD0iTTY4LDBsNjksNzMybDU5LDBsMjA3LC02NjNsMjAyLDY2M2w1OSwwbDc1LC03MzJsLTQxLDBsLTY5LDY2N2wtMjA0LC02NjdsLTQ0LDBsLTIwOCw2NjdsLTY0LC02Njd6IgogICBpZD0iZ2x5cGg0MjE5IiAvPgo8Z2x5cGgKICAgdW5pY29kZT0iTiIKICAgaG9yaXotYWR2LXg9IjY3MCIKICAgZD0iTTk4LDBsMCw3MzJsNDMsMGw0MjMsLTY1NWwwLDY1NWw0MSwwbDAsLTczMmwtNDEsMGwtNDI1LDY1NWwwLC02NTV6IgogICBpZD0iZ2x5cGg0MjIxIiAvPgo8Z2x5cGgKICAgdW5pY29kZT0iTyIKICAgaG9yaXotYWR2LXg9IjY3NSIKICAgZD0iTTU5NCw2MTFDNjE1LDU2MCA2MjYsNDc3IDYyNiwzNjFDNjI2LDI0MCA2MTIsMTUwIDU4Myw5M0M1NzAsNjYgNTUxLDQ2IDUyNywzMkM1MDMsMTcgNDc4LDggNDUyLDNDNDI2LC0yIDM5NSwtNCAzNTksLTRDMzIyLC00IDI5MywtMyAyNzEsMEMyNDksMyAyMjcsOCAyMDQsMTdDMTgxLDI1IDE2MiwzNyAxNDksNTRDMTM2LDcwIDEyMyw5MSAxMTIsMTE4QzEwMSwxNDUgOTMsMTc4IDg4LDIxOUM4MywyNTkgODAsMzEwIDgwLDM3MUM4MCw0MzIgODQsNDg1IDkzLDUzMkMxMDIsNTc4IDExMyw2MTUgMTI3LDY0MkMxNDAsNjY5IDE2MCw2ODkgMTg1LDcwNEMyMTAsNzE4IDIzNCw3MjcgMjU5LDczMUMyODQsNzM1IDMxNCw3MzcgMzQ5LDczN0MzODQsNzM3IDQxMyw3MzYgNDM1LDczM0M0NTYsNzMwIDQ3OCw3MjUgNTAxLDcxNkM1MjQsNzA3IDU0Miw2OTUgNTU2LDY3OEM1NjksNjYxIDU4Miw2MzggNTk0LDYxMU0xMzgsNTUwQzEzMiw1MjcgMTI4LDUwMCAxMjUsNDY5QzEyMiw0MzcgMTIxLDM5MyAxMjEsMzM4QzEyMSwyODIgMTI1LDIzMyAxMzMsMTkxQzE0MCwxNDggMTU0LDExNiAxNzQsOTNDMTk0LDcwIDIxNyw1NSAyNDQsNDhDMjcxLDQxIDMwNywzNyAzNTMsMzdDMzk4LDM3IDQzNCw0MSA0NjEsNDlDNDg4LDU2IDUxMSw3MSA1MzEsOTRDNTUxLDExNyA1NjUsMTQ5IDU3MywxOTJDNTgxLDIzNSA1ODUsMjg5IDU4NSwzNTZDNTg1LDQyMiA1ODIsNDc2IDU3NSw1MThDNTY4LDU1OSA1NTksNTkyIDU0OCw2MTZDNTM3LDYzOSA1MjEsNjU3IDUwMCw2NjlDNDc5LDY4MSA0NTgsNjg5IDQzOCw2OTJDNDE3LDY5NSAzOTMsNjk2IDM2NSw2OTZDMzM2LDY5NiAzMTYsNjk2IDMwMyw2OTVDMjkwLDY5NCAyNzUsNjkzIDI1OCw2OTBDMjQxLDY4NyAyMjcsNjgyIDIxNyw2NzZDMjA3LDY2OSAxOTYsNjYxIDE4NSw2NTBDMTczLDYzOSAxNjQsNjI2IDE1Nyw2MDlDMTUwLDU5MiAxNDQsNTczIDEzOCw1NTB6IgogICBpZD0iZ2x5cGg0MjIzIiAvPgo8Z2x5cGgKICAgdW5pY29kZT0iVCIKICAgaG9yaXotYWR2LXg9IjU5NSIKICAgZD0iTTQ2LDY5MWwwLDQxbDUxNSwwbDAsLTQxbC0yNDAsMGwwLC02OTFsLTQxLDBsMCw2OTF6IgogICBpZD0iZ2x5cGg0MjI1IiAvPgo8Z2x5cGgKICAgdW5pY29kZT0iVSIKICAgaG9yaXotYWR2LXg9IjY4MCIKICAgZD0iTTk4LDMyMGwwLDQxMmw0MSwwbDAsLTQxMkMxMzksMjUxIDE0NCwxOTcgMTUzLDE1N0MxNjIsMTE2IDE3OSw4OCAyMDMsNzFDMjI3LDU0IDI0OSw0NCAyNjgsNDFDMjg3LDM4IDMxNywzNiAzNTksMzZsMSwwQzQzNywzNiA0ODcsNDkgNTExLDc2QzU0MSwxMDkgNTYwLDE1MiA1NjcsMjA0QzU3MiwyMzcgNTc0LDI3NiA1NzQsMzIwbDAsNDEybDQyLDBsMCwtNDEyQzYxNiwyMTUgNjAzLDEzOSA1NzYsOTJDNTY3LDc2IDU1OCw2MyA1NTAsNTJDNTQxLDQxIDUzMCwzMSA1MTYsMjRDNTAyLDE3IDQ5MCwxMSA0ODEsOEM0NzEsNCA0NTgsMSA0NDEsLTFDNDE5LC00IDQwMCwtNSAzODMsLTVDMzY2LC01IDM1MiwtNSAzNDEsLTVDMzMwLC01IDMxOSwtNSAzMTAsLTRDMzAwLC00IDI4NiwtMyAyNjksLTFDMjUxLDAgMjM3LDMgMjI4LDdDMjE5LDEwIDIwNywxNiAxOTMsMjRDMTc5LDMxIDE2OCw0MCAxNjEsNTFDMTUzLDYyIDE0NCw3NSAxMzUsOTJDMTI2LDEwOCAxMTksMTI3IDExNCwxNDhDMTAzLDIwMiA5OCwyNTkgOTgsMzIweiIKICAgaWQ9ImdseXBoNDIyNyIgLz4KPGdseXBoCiAgIHVuaWNvZGU9IlkiCiAgIGhvcml6LWFkdi14PSI2MjIiCiAgIGQ9Ik0zMzYsMGwtNDEsMGwwLDI2MGwtMjM5LDQ3Mmw0NSwwbDIxNSwtNDIybDIzNCw0MjJsNDYsMGwtMjYwLC00NzJ6IgogICBpZD0iZ2x5cGg0MjI5IiAvPgo8L2ZvbnQ+CgoJPHBhdGgKICAgZmlsbD0iI2ZmZmZmZiIKICAgZD0iTSAxMjQuOCw4Mi4yIEggNDEuOSBDIDQwLjgsODIuMiA0MCw4MS4zIDQwLDgwLjMgViA1OC43IGMgMCwtMS4xIDAuOSwtMS45IDEuOSwtMS45IGggODIuOSBjIDEuMSwwIDEuOSwwLjkgMS45LDEuOSBWIDgwIGMgMCwxLjEgLTAuNywyLjIgLTEuOSwyLjIgeiIKICAgaWQ9InBhdGg0MjMzIiAvPgo8cGF0aAogICBmaWxsPSIjZmZmZmZmIgogICBkPSJNIDEwMi42LDExNS41IEggNDIuMSBDIDQxLDExNS41IDQwLDExNC42IDQwLDExMy40IFYgOTIuMiBjIDAsLTEuMSAwLjksLTIuMSAyLjEsLTIuMSBoIDYwLjUgYyAxLjEsMCAyLjEsMC45IDIuMSwyLjEgdiAyMS4yIGMgMCwxLjIgLTAuOSwyLjEgLTIuMSwyLjEgeiIKICAgaWQ9InBhdGg0MjM1IiAvPgo8bGluZWFyR3JhZGllbnQKICAgaWQ9IlNWR0lEXzFfIgogICBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSIKICAgeDE9IjYxLjQwMDAwMiIKICAgeTE9IjExNy40Mzk2IgogICB4Mj0iMTc1Ljc4NTEiCiAgIHkyPSIxMTcuNDM5NiIKICAgZ3JhZGllbnRUcmFuc2Zvcm09Im1hdHJpeCgwLjc2MDEsMCwwLDAuNzYwMSwyMy4wMTk2LDQ2LjM1MikiPgoJPHN0b3AKICAgb2Zmc2V0PSIwLjE2NTYiCiAgIHN0eWxlPSJzdG9wLWNvbG9yOiNEMEJEMkIiCiAgIGlkPSJzdG9wNDIzNyIgLz4KCTxzdG9wCiAgIG9mZnNldD0iMSIKICAgc3R5bGU9InN0b3AtY29sb3I6I0QwQkQyQjtzdG9wLW9wYWNpdHk6MCIKICAgaWQ9InN0b3A0MjM5IiAvPgo8L2xpbmVhckdyYWRpZW50Pgo8cGF0aAogICBmaWxsPSJ1cmwoI1NWR0lEXzFfKSIKICAgZD0iTSAxNTQuNiwxNDguMyBIIDcxLjcgYyAtMS4xLDAgLTIuMSwtMC45IC0yLjEsLTIuMSBWIDEyNSBjIDAsLTEuMSAwLjksLTIuMSAyLjEsLTIuMSBoIDgyLjcgYyAxLjEsMCAyLjEsMC45IDIuMSwyLjEgdiAyMS4yIGMgMCwxLjIgLTAuOSwyLjEgLTEuOSwyLjEgeiIKICAgaWQ9InBhdGg0MjQyIgogICBzdHlsZT0iZmlsbDp1cmwoI1NWR0lEXzFfKSIgLz4KPGcKICAgaWQ9Imc0MjU2IgogICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyOC45LDM0LjgpIj4KCTxwYXRoCiAgIGZpbGw9IiNmZmZmZmYiCiAgIGQ9Im0gMjM5LjYsMTAwLjggYyAtNC40LDEuNiAtMTAuMSwzLjQgLTE3LjEsNC45IC03LjIsMS42IC0xNC4zLDIuNSAtMjEuMywyLjUgLTE2LjQsMCAtMjkuMywtNC40IC0zOC42LC0xMy40IC05LjMsLTkgLTEzLjksLTIxLjMgLTEzLjksLTM3IDAsLTE1IDQuOCwtMjcuMiAxNC4xLC0zNi4zIDkuMywtOS4yIDIyLjYsLTEzLjggMzkuMywtMTMuOCA2LjMsMCAxMi4zLDAuNSAxOC4yLDEuOCA1LjgsMS4xIDEyLjIsMy40IDE5LjIsNi45IFYgMzkgaCAtMi44IGMgLTEuMiwtMC45IC0zLC0yLjEgLTUuMywtMy45IC0yLjMsLTEuOCAtNC42LC0zLjIgLTYuNywtNC4yIC0yLjUsLTEuNCAtNS41LC0yLjYgLTguOCwtMy41IC0zLjQsLTEuMSAtNi45LC0xLjYgLTEwLjgsLTEuNiAtNC40LDAgLTguNSwwLjcgLTEyLDEuOSAtMy41LDEuMiAtNi45LDMuNCAtOS43LDYgLTIuOCwyLjYgLTQuOSw2IC02LjUsOS45IC0xLjYsNC4xIC0yLjMsOC42IC0yLjMsMTMuOCAwLDEwLjggMi44LDE4LjkgOC41LDI0LjUgNS42LDUuNiAxNC4xLDguNSAyNS4yLDguNSAxLjEsMCAxLjksMCAzLjIsMCAxLjEsMCAyLjEsMCAzLjIsLTAuMiB2IC0xOSBIIDE5NS41IFYgNTMgSCAyNDAgWiIKICAgaWQ9InBhdGg0MjQ0IiAvPgoJPHBhdGgKICAgZmlsbD0iI2ZmZmZmZiIKICAgZD0ibSAyOTguNyw5OC43IGMgLTEuMiwxLjEgLTIuOCwyLjEgLTQuOCwzLjQgLTEuOCwxLjQgLTMuNywyLjUgLTUuMywzLjIgLTIuMywxLjEgLTQuOCwxLjggLTcuMiwyLjMgLTIuNSwwLjUgLTUuMSwwLjcgLTguMSwwLjcgLTYuOSwwIC0xMi43LC0yLjEgLTE3LjUsLTYuNSAtNC44LC00LjIgLTcuMSwtOS43IC03LjEsLTE2LjQgMCwtNS4zIDEuMiwtOS43IDMuNSwtMTMuMSAyLjMsLTMuNCA1LjgsLTYgMTAuMSwtNy45IDQuMiwtMS45IDkuNywtMy40IDE2LC00LjIgNi4zLC0wLjkgMTMuMSwtMS40IDE5LjksLTEuOCBWIDU4IGMgMCwtNC4xIC0xLjYsLTYuOSAtNC45LC04LjMgLTMuNCwtMS42IC04LjEsLTIuMyAtMTQuNSwtMi4zIC0zLjksMCAtNy45LDAuNyAtMTIuMywyLjEgLTQuNCwxLjQgLTcuNiwyLjUgLTkuMywzLjIgaCAtMi4xIFYgMzUgYyAyLjUsLTAuNyA2LjUsLTEuNCAxMi4yLC0yLjMgNS41LC0wLjkgMTEuMSwtMS40IDE2LjgsLTEuNCAxMy4yLDAgMjIuOSwyLjEgMjguNyw2LjIgNS44LDQuMSA4LjgsMTAuNCA4LjgsMTkuMiB2IDQ5LjYgaCAtMjMuMSB6IG0gMCwtMTEuNSB2IC0xNSBjIC0zLjIsMC4yIC02LjUsMC41IC0xMC4yLDEuMSAtMy43LDAuNiAtNi41LDEuMSAtOC4zLDEuNiAtMi4zLDAuNyAtNC4xLDEuOCAtNS4zLDMuMiAtMS4yLDEuNCAtMS44LDMuNCAtMS44LDUuNSAwLDEuNiAwLjIsMi44IDAuNCwzLjcgMC4yLDEuMSAwLjksMS44IDEuOSwyLjggMS4xLDAuOSAyLjEsMS42IDMuNSwxLjkgMS40LDAuNCAzLjUsMC41IDYuNSwwLjUgMi4zLDAgNC44LC0wLjUgNy4yLC0xLjQgMi4yLC0xIDQuMywtMi4zIDYuMSwtMy45IHoiCiAgIGlkPSJwYXRoNDI0NiIgLz4KCTxwYXRoCiAgIGZpbGw9IiNmZmZmZmYiCiAgIGQ9Ik0gMzYxLDEwNi4zIEggMzM3LjUgViA1LjIgSCAzNjEgWiIKICAgaWQ9InBhdGg0MjQ4IiAvPgoJPHBhdGgKICAgZmlsbD0iI2ZmZmZmZiIKICAgZD0ibSA0MjEuMSw5OC43IGMgLTEuMiwxLjEgLTIuOCwyLjEgLTQuOCwzLjQgLTEuOCwxLjQgLTMuNywyLjUgLTUuMywzLjIgLTIuMywxLjEgLTQuOCwxLjggLTcuMiwyLjMgLTIuNSwwLjUgLTUuMSwwLjcgLTguMSwwLjcgLTYuOSwwIC0xMi43LC0yLjEgLTE3LjUsLTYuNSAtNC44LC00LjIgLTcuMSwtOS43IC03LjEsLTE2LjQgMCwtNS4zIDEuMiwtOS43IDMuNSwtMTMuMSAyLjMsLTMuNCA1LjgsLTYgMTAuMSwtNy45IDQuNCwtMS45IDkuNywtMy40IDE2LC00LjIgNi4zLC0wLjkgMTMuMSwtMS40IDE5LjksLTEuOCBWIDU4IGMgMCwtNC4xIC0xLjYsLTYuOSAtNC45LC04LjMgLTMuNCwtMS42IC04LjEsLTIuMyAtMTQuNSwtMi4zIC0zLjksMCAtNy45LDAuNyAtMTIuMywyLjEgLTQuNCwxLjQgLTcuNiwyLjUgLTkuMywzLjIgaCAtMi4xIFYgMzUgYyAyLjUsLTAuNyA2LjUsLTEuNCAxMi4yLC0yLjMgNS41LC0wLjkgMTEuMSwtMS40IDE2LjgsLTEuNCAxMy4yLDAgMjIuOSwyLjEgMjguNyw2LjIgNiw0LjEgOC44LDEwLjQgOC44LDE5LjIgdiA0OS42IGggLTIzLjEgeiBtIDAsLTExLjUgdiAtMTUgYyAtMy4yLDAuMiAtNi41LDAuNSAtMTAuMiwxLjEgLTMuNywwLjYgLTYuNSwxLjEgLTguMywxLjYgLTIuMywwLjcgLTQuMSwxLjggLTUuMywzLjIgLTEuMiwxLjQgLTEuOCwzLjQgLTEuOCw1LjUgMCwxLjYgMC4yLDIuOCAwLjQsMy43IDAuMiwxLjEgMC45LDEuOCAxLjksMi44IDEuMSwwLjkgMi4xLDEuNiAzLjUsMS45IDEuNCwwLjQgMy41LDAuNSA2LjUsMC41IDIuMywwIDQuOCwtMC41IDcuMiwtMS40IDIuMiwtMSA0LjMsLTIuMyA2LjEsLTMuOSB6IgogICBpZD0icGF0aDQyNTAiIC8+Cgk8cGF0aAogICBmaWxsPSIjZmZmZmZmIgogICBkPSJtIDUzNi4xLDEwNi4zIGggLTI3LjMgbCAtMTUuNSwtMjEuNyAtMTYsMjEuOSBIIDQ1MC41IEwgNDc5LjEsNzAgNDUwLjksMzMuNSBoIDI3LjMgTCA0OTMuNiw1NSA1MDguOSwzMy41IGggMjYuOCBsIC0yOC40LDM2IHoiCiAgIGlkPSJwYXRoNDI1MiIgLz4KCTxwYXRoCiAgIGZpbGw9IiNmZmZmZmYiCiAgIGQ9Im0gNTc1LjgsODAuNSAxNi42LC00Ny4xIGggMjQgTCA1NzUuOCwxMzMgSCA1NTAuNCBMIDU2MiwxMDUuNyA1MzMuOCwzMy40IGggMjQuNSB6IgogICBpZD0icGF0aDQyNTQiIC8+CjwvZz4KCjwvc3ZnPgo='


def server_name(search_url):
    """Search the GALAXY_SERVERS dict for the server with the matching URL"""
    for name, url in GALAXY_SERVERS.items():
        if url == search_url: return name
    return search_url


def galaxy_url(session):
    return session.gi.url[:-4] if hasattr(session, 'gi') else session.url[:-4]


def color_string(r, g, b, a, secondary_color=False):
    return f'rgba({r}, {g}, {b}, {0.50 if secondary_color else a})'


def session_color(index=0, secondary_color=False):
    if type(index) == int:
        return color_string(*GALAXY_COLORS[index % len(GALAXY_COLORS)], secondary_color)
    else:
        servers = list(GALAXY_SERVERS.values())
        for i in range(len(servers)):
            if index == servers[i]: return color_string(*GALAXY_COLORS[i], secondary_color)
        return color_string(*GALAXY_COLORS[-1], secondary_color)


def data_icon(status):
    if status == 'ok': return 'far fa-check-circle'
    elif status == 'error': return 'fas fa-exclamation-circle'
    elif status == 'new': return 'far fa-clock'
    elif status == 'running': return 'far fa-clock'
    else: return None


def data_name(dataset):
    return f'{dataset.wrapped["hid"]}: {dataset.name}'


def poll_data_and_update(dataset):
    if dataset.state == 'new' or dataset.state == 'running':
        initial_state = dataset.state

        def update_registry():
            if dataset.state != initial_state:
                origin = server_name(galaxy_url(dataset.gi))
                uri = dataset.id
                data = DataManager.instance().get(origin=origin, uri=uri)
                if data:
                    data.icon = data_icon(dataset.state)
                    if dataset.state == 'error': data.kind = 'error'
                    ToolManager.instance().send_update()
            poll_data_and_update(dataset)

        timer = Timer(15.0, lambda: dataset.refresh() and update_registry())
        timer.start()


def current_history(session):
    if hasattr(session, 'current_history') and session.current_history: return session.current_history
    else: return session.histories.list(deleted=False)[0]


def skip_tool(tool):
    return tool.name in ['Data Fetch', 'Export datasets', 'Apply rules', 'Upload File']


def strip_version(raw_id):
    if '/' in raw_id:
        return '/'.join(raw_id.split('/')[0:-1])
    else: return raw_id


def limited_eval(raw):
    # Value is a boolean
    if   raw.lower() == 'true': return True
    elif raw.lower() == 'false': return False

    # Value is an int
    try: return int(raw)
    except ValueError: pass

    # Value is a float
    try: return float(raw)
    except ValueError: pass

    # Value is a string
    return raw


def is_id(text):
    return type(text) == str and len(text) == 32 and all(c in hexdigits for c in text)


def walk_tree(tree, condition, permutation):
    """Walk the given tree structure, and if the node meets the condition, apply the permutation"""
    if condition(tree): permutation(tree)
    if tree.get('test_param'):
        walk_tree(tree['test_param'], condition, permutation)
    if tree.get('cases'):
        for i in tree['cases']:
            walk_tree(i, condition, permutation)
    if tree.get('inputs'):
        for i in tree['inputs']:
            walk_tree(i, condition, permutation)
