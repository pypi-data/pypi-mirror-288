(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1929],{39929:function(e,t,n){Promise.resolve().then(n.bind(n,38874))},38874:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return f}});var s=n(57437),a=n(65104),o=n.n(a),i=n(2265),c=n(48861),r=n(82697),l=n(16463),d=n(58485),u=n(9557);n(7395);var h=n(69591),g=n(23753),m=n(79306);function _(e){let t=(0,l.useSearchParams)().get("conversationId"),[n,a]=(0,i.useState)(""),[c,d]=(0,i.useState)(!1),[u,h]=(0,i.useState)(null),m=e.setQueryToProcess,_=e.onConversationIdChange;if((0,i.useEffect)(()=>{let e=localStorage.getItem("message");e&&(d(!0),m(e))},[m]),(0,i.useEffect)(()=>{n&&(d(!0),m(n))},[n,m]),(0,i.useEffect)(()=>{t&&(null==_||_(t))},[t,_]),(0,i.useEffect)(()=>{e.streamedMessages&&e.streamedMessages.length>0&&e.streamedMessages[e.streamedMessages.length-1].completed?d(!1):a("")},[e.streamedMessages]),!t){window.location.href="/";return}return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:o().chatBodyFull,children:(0,s.jsx)(r.Z,{conversationId:t,setTitle:e.setTitle,setAgent:h,pendingMessage:c?n:"",incomingMessages:e.streamedMessages})}),(0,s.jsx)("div",{className:"".concat(o().inputBox," p-1 md:px-2 shadow-md bg-background align-middle items-center justify-center dark:bg-neutral-700 dark:border-0 dark:shadow-sm rounded-t-2xl rounded-b-none md:rounded-xl"),children:(0,s.jsx)(g.Z,{agentColor:null==u?void 0:u.color,isLoggedIn:e.isLoggedIn,sendMessage:e=>a(e),sendDisabled:c,chatOptionsData:e.chatOptionsData,conversationId:t,isMobileWidth:e.isMobileWidth,setUploadedFiles:e.setUploadedFiles})})]})}function f(){let e="Khoj AI - Chat",[t,n]=(0,i.useState)(null),[a,r]=(0,i.useState)(!0),[l,g]=(0,i.useState)(e),[f,p]=(0,i.useState)(null),[x,v]=(0,i.useState)([]),[j,y]=(0,i.useState)(""),[w,b]=(0,i.useState)(!1),[M,S]=(0,i.useState)([]),[C,I]=(0,i.useState)(!1),N=(0,h.k6)(),E=(0,m.G)();async function L(e){if(!e.ok)throw Error(e.statusText);if(!e.body)throw Error("Response body is null");let t=e.body.getReader(),n=new TextDecoder,s="␃\uD83D\uDD1A␗",a="",o=[],i={};for(;;){let e;let{done:c,value:r}=await t.read();if(c){y(""),b(!1);break}for(a+=n.decode(r,{stream:!0});-1!==(e=a.indexOf(s));){let t=a.slice(0,e);if(a=a.slice(e+s.length),t){let e=x.find(e=>!e.completed);if(!e){console.error("No current message found");return}({context:o,onlineContext:i}=(0,u.VK)(t,e,o,i)),v([...x])}}}}async function B(){if(localStorage.removeItem("message"),!j||!f)return;let e="/api/chat?q=".concat(encodeURIComponent(j),"&conversation_id=").concat(f,"&stream=true&client=web");N&&(e+="&region=".concat(N.region,"&country=").concat(N.country,"&city=").concat(N.city,"&timezone=").concat(N.timezone));let t=await fetch(e);try{await L(t)}catch(e){console.log(e)}}return((0,i.useEffect)(()=>{fetch("/api/chat/options").then(e=>e.json()).then(e=>{r(!1),e&&n(e)}).catch(e=>{console.error(e)}),(0,h.EK)(),I(window.innerWidth<786),window.addEventListener("resize",()=>{I(window.innerWidth<786)})},[]),(0,i.useEffect)(()=>{if(j){let e={rawResponse:"",trainOfThought:[],context:[],onlineContext:{},completed:!1,timestamp:new Date().toISOString(),rawQuery:j||""};v(t=>[...t,e]),b(!0)}},[j]),(0,i.useEffect)(()=>{w&&B()},[w]),a)?(0,s.jsx)(d.Z,{}):(0,s.jsxs)("div",{className:"".concat(o().main," ").concat(o().chatLayout),children:[(0,s.jsx)("title",{children:"".concat(e).concat(l&&l!==e?": ".concat(l):"")}),(0,s.jsx)("div",{children:(0,s.jsx)(c.Z,{conversationId:f,uploadedFiles:M,isMobileWidth:C})}),(0,s.jsx)("div",{className:o().chatBox,children:(0,s.jsxs)("div",{className:o().chatBoxBody,children:[!C&&(0,s.jsx)("div",{className:"text-nowrap text-ellipsis overflow-hidden max-w-screen-md grid items-top font-bold mr-8",children:l&&(0,s.jsx)("h2",{className:"text-lg text-ellipsis whitespace-nowrap overflow-x-hidden pt-6",children:l})}),(0,s.jsx)(i.Suspense,{fallback:(0,s.jsx)(d.Z,{}),children:(0,s.jsx)(_,{isLoggedIn:null!==E,streamedMessages:x,chatOptionsData:t,setTitle:g,setQueryToProcess:y,setUploadedFiles:S,isMobileWidth:C,onConversationIdChange:e=>{p(e)}})})]})})]})}},69591:function(e,t,n){"use strict";n.d(t,{EK:function(){return i},LF:function(){return o},k6:function(){return c}});var s=n(29039);let a=()=>window.fetch("https://ipapi.co/json").then(e=>e.json()).catch(e=>console.log(e)),o=e=>e.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.slice(1).toLowerCase());function i(){console.log("%c %s","font-family:monospace",'\n        __  __     __  __     ______       __        _____      __\n       /\\ \\/ /    /\\ \\_\\ \\   /\\  __ \\     /\\ \\      /\\  __ \\   /\\ \\\n       \\ \\  _"-.  \\ \\  __ \\  \\ \\ \\/\\ \\   _\\_\\ \\     \\ \\  __ \\  \\ \\ \\\n        \\ \\_\\ \\_\\  \\ \\_\\ \\_\\  \\ \\_____\\ /\\_____\\     \\ \\_\\ \\_\\  \\ \\_\\\n         \\/_/\\/_/   \\/_/\\/_/   \\/_____/ \\/_____/      \\/_/\\/_/   \\/_/\n\n\n       Greetings traveller,\n\n       I am ✨Khoj✨, your open-source, personal AI copilot.\n\n       See my source code at https://github.com/khoj-ai/khoj\n       Read my operating manual at https://docs.khoj.dev\n       ')}function c(){let{data:e,error:t}=(0,s.ZP)("/api/ip",a,{revalidateOnFocus:!1});return t||!e?null:e}},82697:function(e,t,n){"use strict";n.d(t,{Z:function(){return f}});var s=n(57437),a=n(15238),o=n.n(a),i=n(2265),c=n(89178),r=n(94880),l=n(58485),d=n(16288),u=n(26100),h=n(19666),g=n(50495),m=e=>{let{name:t,avatar:n,link:a,description:o}=e;return(0,s.jsx)("div",{className:"relative group flex",children:(0,s.jsx)(h.pn,{children:(0,s.jsxs)(h.u,{children:[(0,s.jsx)(h.aJ,{asChild:!0,children:(0,s.jsxs)(g.z,{variant:"ghost",className:"flex items-center justify-center",children:[n,(0,s.jsx)("div",{children:t})]})}),(0,s.jsx)(h._v,{children:(0,s.jsxs)("div",{className:"w-80 h-30",children:[(0,s.jsx)("a",{href:a,target:"_blank",rel:"noreferrer",className:"mt-1 ml-2 block no-underline",children:(0,s.jsxs)("div",{className:"flex items-center justify-start gap-2",children:[n,(0,s.jsxs)("div",{className:"mr-2 mt-1 flex justify-center items-center text-sm font-semibold text-gray-800",children:[t,(0,s.jsx)(u.o,{weight:"bold",className:"ml-1"})]})]})}),o&&(0,s.jsx)("p",{className:"mt-2 ml-6 text-sm text-gray-600 line-clamp-2",children:o||"A Khoj agent"})]})})]})})})},_=n(89417);function f(e){let[t,n]=(0,i.useState)(null),[a,u]=(0,i.useState)(0),[h,g]=(0,i.useState)(!0),f=(0,i.useRef)(null),p=(0,i.useRef)(null),x=(0,i.useRef)(null),[v,j]=(0,i.useState)(null),[y,w]=(0,i.useState)(!1),[b,M]=(0,i.useState)(!1);(0,i.useEffect)(()=>{window.addEventListener("resize",()=>{M(window.innerWidth<768)}),M(window.innerWidth<768)},[]),(0,i.useEffect)(()=>{a<2&&((null==t?void 0:t.chat.length)||setTimeout(()=>{S()},500))},[t,a]),(0,i.useEffect)(()=>{if(!h||y)return;let s=new IntersectionObserver(s=>{s[0].isIntersecting&&h&&(w(!0),function(s){if(!h||y)return;let a=s+1,o="";if(e.conversationId)o="/api/chat/history?client=web&conversation_id=".concat(e.conversationId,"&n=").concat(10*a);else{if(!e.publicConversationSlug)return;o="/api/chat/share/history?client=web&public_conversation_slug=".concat(e.publicConversationSlug,"&n=").concat(10*a)}fetch(o).then(e=>e.json()).then(a=>{if(e.setTitle(a.response.slug),a&&a.response&&a.response.chat&&a.response.chat.length>0){if(a.response.chat.length===(null==t?void 0:t.chat.length)){g(!1),w(!1);return}e.setAgent(a.response.agent),n(a.response),s<2&&S(),w(!1)}else{if(a.response.agent&&a.response.conversation_id){let t={chat:[],agent:a.response.agent,conversation_id:a.response.conversation_id,slug:a.response.slug};e.setAgent(a.response.agent),n(t)}g(!1),w(!1)}}).catch(e=>{console.error(e),window.location.href="/"})}(a),u(e=>e+1))},{threshold:1});return x.current&&s.observe(x.current),()=>s.disconnect()},[h,a,y]),(0,i.useEffect)(()=>{g(!0),w(!1),u(0),n(null)},[e.conversationId]),(0,i.useEffect)(()=>{if(e.incomingMessages){let t=e.incomingMessages[e.incomingMessages.length-1];t&&!t.completed&&j(e.incomingMessages.length-1)}C()&&S()},[e.incomingMessages]);let S=()=>{p.current&&p.current.scrollIntoView(!1)},C=()=>{if(!p.current)return!1;let{scrollTop:e,scrollHeight:t,clientHeight:n}=p.current;return e+n>=t-25};return e.conversationId||e.publicConversationSlug?(0,s.jsx)(r.x,{className:"h-[80vh]",children:(0,s.jsx)("div",{ref:f,children:(0,s.jsxs)("div",{className:o().chatHistory,ref:p,children:[(0,s.jsx)("div",{ref:x,style:{height:"1px"},children:y&&(0,s.jsx)(l.l,{message:"Loading Conversation",className:"opacity-50"})}),t&&t.chat&&t.chat.map((e,n)=>(0,s.jsx)(c.Z,{isMobileWidth:b,chatMessage:e,customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500"),isLastMessage:n===t.chat.length-1},"".concat(n,"fullHistory"))),e.incomingMessages&&e.incomingMessages.map((e,n)=>(0,s.jsxs)(i.Fragment,{children:[(0,s.jsx)(c.Z,{isMobileWidth:b,chatMessage:{message:e.rawQuery,context:[],onlineContext:{},created:e.timestamp,by:"you",automationId:""},customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500")},"".concat(n,"outgoing")),e.trainOfThought&&function(e,t,n,a){let i=arguments.length>4&&void 0!==arguments[4]&&arguments[4],r=e.length-1;return(0,s.jsxs)("div",{className:"".concat(o().trainOfThought," shadow-sm"),children:[!i&&(0,s.jsx)(l.l,{className:"float-right"}),e.map((e,a)=>(0,s.jsx)(c.H,{message:e,primary:a===r&&t&&!i,agentColor:n},"train-".concat(a)))]},a)}(e.trainOfThought,n===v,(null==t?void 0:t.agent.color)||"orange","".concat(n,"trainOfThought"),e.completed),(0,s.jsx)(c.Z,{isMobileWidth:b,chatMessage:{message:e.rawResponse,context:e.context,onlineContext:e.onlineContext,created:e.timestamp,by:"khoj",automationId:"",rawQuery:e.rawQuery},customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500"),isLastMessage:!0},"".concat(n,"incoming"))]},"incomingMessage".concat(n))),e.pendingMessage&&(0,s.jsx)(c.Z,{isMobileWidth:b,chatMessage:{message:e.pendingMessage,context:[],onlineContext:{},created:new Date().getTime().toString(),by:"you",automationId:""},customClassName:"fullHistory",borderLeftColor:"".concat(null==t?void 0:t.agent.color,"-500"),isLastMessage:!0},"pendingMessage-".concat(e.pendingMessage.length)),t&&(0,s.jsx)("div",{className:"".concat(o().agentIndicator," pb-4"),children:(0,s.jsx)("div",{className:"relative group mx-2 cursor-pointer",children:(0,s.jsx)(m,{name:t&&t.agent&&t.agent.name?t.agent.name:"Agent",link:t&&t.agent&&t.agent.slug?"/agents?agent=".concat(t.agent.slug):"/agents",avatar:(0,_.T)(t.agent.icon,t.agent.color)||(0,s.jsx)(d.v,{}),description:t&&t.agent&&t.agent.persona?t.agent.persona:""})})})]})})}):null}},16463:function(e,t,n){"use strict";var s=n(71169);n.o(s,"useSearchParams")&&n.d(t,{useSearchParams:function(){return s.useSearchParams}})},65104:function(e){e.exports={main:"chat_main__8xQu5",suggestions:"chat_suggestions__m8n2t",inputBox:"chat_inputBox__LOFws",chatBodyFull:"chat_chatBodyFull__FfKEK",chatBody:"chat_chatBody__sS1LX",chatLayout:"chat_chatLayout__pR203",chatBox:"chat_chatBox__FBct_",titleBar:"chat_titleBar__R5QlK",chatBoxBody:"chat_chatBoxBody__qT_SC",agentIndicator:"chat_agentIndicator__8V55w"}},15238:function(e){e.exports={chatHistory:"chatHistory_chatHistory__CoaVT",chatLayout:"chatHistory_chatLayout__ABli_",agentIndicator:"chatHistory_agentIndicator__wOU1f",trainOfThought:"chatHistory_trainOfThought__mMWSR"}}},function(e){e.O(0,[7812,3630,3170,3954,9001,3062,743,7071,2614,9693,1603,9417,9178,3753,2971,7023,1744],function(){return e(e.s=39929)}),_N_E=e.O()}]);